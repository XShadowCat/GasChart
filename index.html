<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#010409" id="themeColor">
<title>Plynograf</title>
  <link rel="icon" href="icon.svg" type="image/svg+xml">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:system-ui,'Segoe UI',sans-serif;background:#010409;color:#e6edf3;min-height:100vh;transition:background .25s,color .25s;}
body.light{background:#f6f8fa;color:#1f2328;}
button{cursor:pointer;font-family:inherit;border:none;background:none;}
input{font-family:inherit;outline:none;}
input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;}
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-thumb{background:#30363d;border-radius:4px;}

/* HEADER */
#header{background:#0d1117;border-bottom:1px solid #21262d;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;transition:background .25s,border-color .25s;}
body.light #header{background:#fff;border-color:#d0d7de;}
.logo{display:flex;align-items:center;gap:10px;}
.logo-icon{width:32px;height:32px;border-radius:7px;display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;}
.logo-title{font-size:15px;font-weight:700;letter-spacing:-.02em;}
.logo-sub{font-size:10px;color:#6e7681;font-family:monospace;}
body.light .logo-sub{color:#6e7781;}
.header-right{display:flex;gap:8px;align-items:center;}
.btn-theme{background:#161b22;border:1px solid #30363d;border-radius:6px;color:#8b949e;padding:5px 10px;font-size:16px;line-height:1;transition:all .15s;}
body.light .btn-theme{background:#f3f4f6;border-color:#b1bac4;}
.unit-toggle{display:flex;background:#161b22;border:1px solid #30363d;border-radius:6px;overflow:hidden;}
body.light .unit-toggle{background:#f6f8fa;border-color:#b1bac4;}
.unit-btn{padding:6px 12px;font-weight:700;font-size:12px;font-family:monospace;color:#6e7681;transition:all .15s;}
.unit-btn.active{background:#f97316;color:#fff;}
body.light .unit-btn.active{background:#d95f00;}
.lang-toggle{display:flex;background:#161b22;border:1px solid #30363d;border-radius:6px;overflow:hidden;}
body.light .lang-toggle{background:#f6f8fa;border-color:#b1bac4;}
.lang-btn{padding:6px 10px;font-weight:700;font-size:12px;font-family:monospace;color:#6e7681;transition:all .15s;}
.lang-btn.active{background:#f97316;color:#fff;}
body.light .lang-btn.active{background:#d95f00;color:#fff;}

/* TABS */
#tabs{background:#0d1117;border-bottom:1px solid #21262d;display:flex;padding:0 16px;overflow-x:auto;transition:background .25s;}
body.light #tabs{background:#fff;border-color:#d0d7de;}
.tab{background:none;border:none;border-bottom:2px solid transparent;color:#8b949e;padding:11px 14px;font-size:13px;font-weight:500;white-space:nowrap;transition:color .15s;}
.tab.active{color:#f97316;border-bottom-color:#f97316;}
body.light .tab.active{color:#d95f00;border-bottom-color:#d95f00;}

/* CONTENT */
#content{padding:16px;max-width:940px;margin:0 auto;}
.screen{display:none;}
.screen.active{display:block;}

/* CARDS */
.stat-cards{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;}
.stat-card{background:#0d1117;border:1px solid #21262d;border-radius:8px;padding:12px 14px;flex:1;min-width:120px;transition:background .25s,border-color .25s;}
body.light .stat-card{background:#fff;border-color:#d0d7de;box-shadow:0 1px 3px rgba(0,0,0,.06);}
.stat-label{font-size:10px;color:#6e7681;text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px;}
body.light .stat-label{color:#6e7781;}
.stat-value{font-size:18px;font-weight:700;font-family:monospace;}
.stat-sub{font-size:11px;color:#6e7681;margin-top:3px;}
body.light .stat-sub{color:#6e7781;}

/* PANEL */
.panel{background:#0d1117;border:1px solid #21262d;border-radius:10px;overflow:hidden;margin-bottom:16px;transition:background .25s,border-color .25s;}
body.light .panel{background:#fff;border-color:#d0d7de;box-shadow:0 1px 3px rgba(0,0,0,.06);}
.panel-header{padding:10px 14px;border-bottom:1px solid #21262d;background:#161b22;display:flex;justify-content:space-between;align-items:center;font-size:10px;color:#6e7681;text-transform:uppercase;letter-spacing:.1em;font-family:monospace;transition:background .25s,border-color .25s;}
body.light .panel-header{background:#f3f4f6;border-color:#d0d7de;}
.panel-body{padding:16px;}

/* CHART TOGGLE */
.chart-mode-toggle{display:flex;background:#161b22;border:1px solid #30363d;border-radius:6px;overflow:hidden;width:fit-content;margin-bottom:12px;}
body.light .chart-mode-toggle{background:#f6f8fa;border-color:#b1bac4;}
.chart-mode-btn{padding:7px 14px;color:#6e7681;border-right:1px solid #30363d;font-size:13px;font-weight:500;transition:all .15s;}
body.light .chart-mode-btn{border-color:#b1bac4;}
.chart-mode-btn.active{background:#21262d;color:#e6edf3;}
body.light .chart-mode-btn.active{background:#e5e7eb;color:#1f2328;}

/* YEAR PILLS */
.year-pills{display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-bottom:12px;}
.year-pill{padding:4px 12px;border-radius:4px;border:1.5px solid;font-weight:700;font-size:12px;font-family:monospace;transition:all .15s;}

/* MONTH PILLS */
.month-pills{display:flex;gap:4px;flex-wrap:wrap;align-items:center;margin-bottom:12px;}
.month-pill{padding:3px 8px;border-radius:4px;border:1px solid #30363d;color:#8b949e;font-size:11px;font-family:monospace;transition:all .15s;}
body.light .month-pill{border-color:#b1bac4;color:#57606a;}
.month-pill.active{border-color:#f97316;background:rgba(249,115,22,.13);color:#f97316;}
body.light .month-pill.active{border-color:#d95f00;background:rgba(217,95,0,.1);color:#d95f00;}

/* CHART */
.chart-wrap{background:#0d1117;border:1px solid #21262d;border-radius:10px;padding:16px 8px 10px;margin-bottom:12px;transition:background .25s,border-color .25s;}
body.light .chart-wrap{background:#fff;border-color:#d0d7de;}
.chart-title{font-size:10px;color:#6e7681;text-transform:uppercase;letter-spacing:.1em;font-family:monospace;margin-bottom:12px;padding-left:8px;}
body.light .chart-title{color:#6e7781;}
.chart-legend{display:flex;gap:14px;justify-content:center;margin-top:8px;flex-wrap:wrap;}
.legend-item{display:flex;align-items:center;gap:5px;font-size:12px;font-family:monospace;font-weight:700;}

/* SVG CHARTS */
svg text{font-family:monospace;}

/* FORM */
.form-row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;}
.form-group{display:flex;flex-direction:column;gap:4px;}
.form-label{font-size:10px;color:#6e7681;text-transform:uppercase;letter-spacing:.08em;}
body.light .form-label{color:#6e7781;}
.form-input{background:#161b22;border:1px solid #30363d;border-radius:6px;color:#e6edf3;padding:8px 12px;font-size:13px;transition:border-color .15s;}
body.light .form-input{background:#f6f8fa;border-color:#b1bac4;color:#1f2328;}
.form-input:focus{border-color:#f97316;}
body.light .form-input:focus{border-color:#d95f00;}
.btn-add{background:#f97316;border-radius:6px;color:#fff;padding:9px 18px;font-size:13px;font-weight:600;}
body.light .btn-add{background:#d95f00;}

/* READINGS LIST */
.reading-row{display:flex;align-items:center;gap:8px;padding:10px 14px;border-bottom:1px solid #21262d;transition:background .25s;}
body.light .reading-row{border-color:#d0d7de;}
.reading-row:last-child{border-bottom:none;}
.reading-row:first-child{border-top:none;}
#readingsList{scrollbar-width:thin;scrollbar-color:#30363d #0d1117;}
#readingsList::-webkit-scrollbar{width:4px;}
#readingsList::-webkit-scrollbar-track{background:#0d1117;}
#readingsList::-webkit-scrollbar-thumb{background:#30363d;border-radius:2px;}
body.light #readingsList{scrollbar-color:#b1bac4 #fff;}
body.light #readingsList::-webkit-scrollbar-track{background:#fff;}
body.light #readingsList::-webkit-scrollbar-thumb{background:#b1bac4;}
.reading-row.latest-row{border-bottom-color:#21262d!important;}
body.light .reading-row.latest-row{border-bottom-color:#d0d7de!important;}
.reading-dot{width:7px;height:7px;border-radius:50%;background:#30363d;flex-shrink:0;}
body.light .reading-dot{background:#b1bac4;}
.reading-dot.latest{background:#f97316;}
body.light .reading-dot.latest{background:#d95f00;}
.reading-date{color:#8b949e;font-size:12px;font-family:monospace;width:95px;flex-shrink:0;}
body.light .reading-date{color:#57606a;}
.reading-value{color:#e6edf3;font-size:14px;font-weight:700;font-family:monospace;flex:1;}
body.light .reading-value{color:#1f2328;}
.reading-diff{font-size:12px;font-family:monospace;color:#f97316;flex-shrink:0;}
body.light .reading-diff{color:#d95f00;}
.reading-days{font-size:11px;font-family:monospace;color:#6e7681;flex-shrink:0;}
body.light .reading-days{color:#6e7781;}
.reading-pct{font-size:11px;font-family:monospace;flex-shrink:0;}
.btn-del{color:#6e7681;font-size:14px;padding:2px 4px;flex-shrink:0;}
body.light .btn-del{color:#6e7781;}
.btn-edit{color:#6e7681;font-size:13px;padding:2px 5px;flex-shrink:0;border-radius:4px;}
body.light .btn-edit{color:#6e7781;}
.reading-row.confirm-del{background:rgba(248,81,73,0.08)!important;border-color:rgba(248,81,73,0.25);}
body.light .reading-row.confirm-del{background:rgba(185,28,28,0.07)!important;}
.confirm-del-msg{font-size:12px;color:#f85149;flex:1;font-weight:500;}
body.light .confirm-del-msg{color:#b91c1c;}
.btn-confirm-del{background:rgba(248,81,73,0.15);border:1px solid rgba(248,81,73,0.4);border-radius:5px;color:#f85149;padding:4px 10px;font-size:12px;font-weight:600;flex-shrink:0;}
body.light .btn-confirm-del{background:rgba(185,28,28,0.1);border-color:rgba(185,28,28,0.3);color:#b91c1c;}
.btn-cancel-del{background:transparent;border:1px solid #30363d;border-radius:5px;color:#8b949e;padding:4px 10px;font-size:12px;flex-shrink:0;}
body.light .btn-cancel-del{border-color:#b1bac4;color:#57606a;}
.reading-row.editing{background:rgba(249,115,22,0.06)!important;padding:8px 14px;flex-wrap:wrap;align-items:center;}
body.light .reading-row.editing{background:rgba(217,95,0,0.05)!important;}
.edit-row-top{display:flex;align-items:center;gap:8px;width:100%;flex-wrap:wrap;}
.edit-input{background:#161b22;border:1px solid #f97316;border-radius:5px;color:#e6edf3;padding:5px 9px;font-size:13px;font-family:monospace;}
body.light .edit-input{background:#fff;border-color:#d95f00;color:#1f2328;}
.edit-input-date{width:132px;}
.edit-input-val{width:120px;}
.edit-input-note{flex:1;min-width:80px;}
.btn-save-edit{background:#f97316;border-radius:5px;color:#fff;padding:5px 12px;font-size:12px;font-weight:600;flex-shrink:0;}
body.light .btn-save-edit{background:#d95f00;}
.btn-cancel-edit{background:transparent;border:1px solid #30363d;border-radius:5px;color:#8b949e;padding:5px 10px;font-size:12px;flex-shrink:0;}
body.light .btn-cancel-edit{border-color:#b1bac4;color:#57606a;}
.edit-err{font-size:11px;color:#f85149;width:100%;margin-top:2px;display:none;}
body.light .edit-err{color:#b91c1c;}

/* ALERTS */
.alert{border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:12px;}
.alert-warn{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.25);color:#f59e0b;}
body.light .alert-warn{background:rgba(161,98,7,.07);border-color:rgba(161,98,7,.25);color:#a16207;}
.alert-success{background:rgba(16,185,129,.07);border:1px solid rgba(16,185,129,.22);color:#34d399;}
body.light .alert-success{background:rgba(10,140,90,.07);border-color:rgba(10,140,90,.25);color:#0a8c5a;}
.alert-error{background:rgba(248,81,73,.1);border:1px solid rgba(248,81,73,.3);color:#f85149;}
body.light .alert-error{background:rgba(185,28,28,.07);border-color:rgba(185,28,28,.25);color:#b91c1c;}

/* NETATMO UPLOAD */
.upload-zone{background:#0d1117;border:2px dashed #30363d;border-radius:12px;padding:24px;text-align:center;margin-bottom:16px;cursor:pointer;transition:border-color .15s,background .25s;}
body.light .upload-zone{background:#fff;border-color:#b1bac4;}
.upload-zone:hover{border-color:#f97316;}
body.light .upload-zone:hover{border-color:#d95f00;}
.upload-icon{font-size:28px;margin-bottom:10px;}
.upload-title{font-size:14px;font-weight:600;margin-bottom:6px;}
.upload-desc{font-size:12px;color:#8b949e;line-height:1.8;margin-bottom:12px;}
body.light .upload-desc{color:#57606a;}
.upload-badges{display:inline-flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;justify-content:center;}
.upload-badge{font-size:12px;color:#34d399;}
body.light .upload-badge{color:#0a8c5a;}
.btn-upload{display:inline-block;background:#f97316;border-radius:6px;padding:8px 20px;font-size:13px;font-weight:600;color:#fff;}
body.light .btn-upload{background:#d95f00;}

/* COVERAGE BARS */
.cov-row{display:flex;align-items:center;gap:8px;margin-bottom:5px;}
.cov-label{font-size:11px;color:#6e7681;width:55px;font-family:monospace;flex-shrink:0;}
body.light .cov-label{color:#6e7781;}
.cov-track{flex:1;height:8px;background:#21262d;border-radius:4px;}
body.light .cov-track{background:#d0d7de;}
.cov-fill{height:100%;border-radius:4px;transition:width .4s;}
.cov-pct{font-size:11px;font-family:monospace;width:36px;text-align:right;flex-shrink:0;}

/* INFO BOX */
.info-box{background:#0d1117;border:1px solid #21262d;border-radius:8px;padding:10px 14px;display:flex;gap:8px;font-size:11px;color:#8b949e;line-height:1.6;margin-top:12px;transition:background .25s,border-color .25s;}
body.light .info-box{background:#fff;border-color:#d0d7de;color:#57606a;}

.hint{font-size:10px;color:#6e7681;}
body.light .hint{color:#6e7781;}
.error-text{color:#f85149;font-size:12px;margin-top:8px;}
body.light .error-text{color:#b91c1c;}

/* AUTH SCREEN */
#authScreen{position:fixed;inset:0;background:#010409;display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px;transition:background .25s;}
body.light #authScreen{background:#f6f8fa;}
.auth-box{background:#0d1117;border:1px solid #21262d;border-radius:14px;padding:32px;width:100%;max-width:380px;transition:background .25s,border-color .25s;}
body.light .auth-box{background:#fff;border-color:#d0d7de;box-shadow:0 4px 24px rgba(0,0,0,.08);}
.auth-logo{display:flex;align-items:center;gap:10px;margin-bottom:28px;justify-content:center;}
.auth-logo-icon{width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;overflow:hidden;}
.auth-logo-name{font-size:20px;font-weight:700;letter-spacing:-.02em;}
.auth-tabs{display:flex;background:#161b22;border-radius:7px;padding:3px;margin-bottom:24px;}
body.light .auth-tabs{background:#f3f4f6;}
.auth-tab{flex:1;padding:7px;border-radius:5px;font-size:13px;font-weight:600;color:#6e7681;transition:all .15s;text-align:center;}
.auth-tab.active{background:#21262d;color:#e6edf3;}
body.light .auth-tab.active{background:#fff;color:#1f2328;box-shadow:0 1px 3px rgba(0,0,0,.1);}
.auth-field{margin-bottom:14px;}
.auth-label{font-size:11px;color:#6e7681;text-transform:uppercase;letter-spacing:.08em;margin-bottom:5px;display:block;}
body.light .auth-label{color:#6e7781;}
.auth-input{width:100%;background:#161b22;border:1px solid #30363d;border-radius:7px;color:#e6edf3;padding:10px 13px;font-size:14px;transition:border-color .15s;}
body.light .auth-input{background:#f6f8fa;border-color:#b1bac4;color:#1f2328;}
.auth-input:focus{border-color:#f97316;outline:none;}
body.light .auth-input:focus{border-color:#d95f00;}
.auth-btn{width:100%;background:#f97316;border-radius:7px;color:#fff;padding:11px;font-size:14px;font-weight:700;margin-top:6px;transition:opacity .15s;}
body.light .auth-btn{background:#d95f00;}
.auth-btn:hover{opacity:.9;}
.auth-btn:disabled{opacity:.5;}
.auth-err{font-size:12px;color:#f85149;margin-top:10px;text-align:center;min-height:18px;}
body.light .auth-err{color:#b91c1c;}
.auth-success{font-size:12px;color:#34d399;margin-top:10px;text-align:center;}
body.light .auth-success{color:#0a8c5a;}

/* USER BADGE in header */
.user-menu{position:relative;}
.user-badge{display:flex;align-items:center;gap:6px;background:#161b22;border:1px solid #30363d;border-radius:6px;padding:5px 10px;font-size:12px;color:#8b949e;cursor:pointer;transition:all .15s;}
body.light .user-badge{background:#f3f4f6;border-color:#b1bac4;}
.user-badge:hover{border-color:#f97316;color:#f97316;}
body.light .user-badge:hover{border-color:#d95f00;color:#d95f00;}
.user-dropdown{position:absolute;top:calc(100% + 6px);right:0;background:#0d1117;border:1px solid #30363d;border-radius:8px;min-width:200px;box-shadow:0 8px 24px rgba(0,0,0,.4);z-index:100;overflow:hidden;display:none;}
body.light .user-dropdown{background:#fff;border-color:#d0d7de;box-shadow:0 8px 24px rgba(0,0,0,.12);}
.user-dropdown.open{display:block;}
.user-dropdown-email{padding:10px 14px;font-size:12px;color:#6e7681;border-bottom:1px solid #21262d;word-break:break-all;}
body.light .user-dropdown-email{color:#57606a;border-color:#d0d7de;}
.user-dropdown-btn{display:flex;align-items:center;gap:8px;width:100%;padding:10px 14px;font-size:13px;color:#f85149;background:none;border:none;cursor:pointer;transition:background .15s;}
body.light .user-dropdown-btn{color:#b91c1c;}
.user-dropdown-btn:hover{background:rgba(248,81,73,.08);}
body.light .user-dropdown-btn:hover{background:rgba(185,28,28,.06);}

/* LOADING overlay */
#loadingOverlay{position:fixed;inset:0;background:rgba(1,4,9,.8);display:flex;align-items:center;justify-content:center;z-index:999;display:none;}
body.light #loadingOverlay{background:rgba(246,248,250,.8);}
.loading-spinner{width:36px;height:36px;border:3px solid #21262d;border-top-color:#f97316;border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
</style>
</head>
<body>


<!-- AUTH SCREEN -->
<div id="authScreen">
  <div class="auth-box">
    <div class="auth-logo">
      <div class="auth-logo-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="46" height="46" style="display:block;"><path fill="#f97316" d="M 0,256 V 0 H 256 512 V 256 512 H 256 0 Z m 199.4,181.8 c -7.5,-8.1 -12.9,-19.6 -15.5,-32.6 -1.8,-9.4 -0.7,-34.1 1.9,-40.7 1,-2.7 2.5,-7.5 3.2,-10.5 1.4,-6.5 12.5,-29.4 17.5,-36.2 3,-4.1 4.375,-5.7375 7.375,-5.7375 2.8,0 2.85,-1.225 3.525,3.2375 0.3,1.2 0.7,3.3 1,4.7 1.5,7.4 3.3,13.3 3.8,12.5 0.3,-0.6 1.1,-3.5 1.8,-6.5 3.3,-14.5 9.3,-28 17.8,-39.9 7,-9.7 9.5,-12.4 20.6,-22.8 8.3,-7.9 9,-8.3 13.3,-8.3 h 4.5 l -0.6,5.3 c -1.5,14 -1.8,32 -0.6,38 2.5,12.8 3.3,16.4 5.3,23 2.3,7.3 2.7,7.2 4.7,-1.5 1.3,-5.8 1.3,-5.8 5,-5.8 4.3,0 5.8,1.4 12.3,11.5 7.1,11.1 14.3,26.3 18.7,39.4 4,11.9 4,12.2 4,26.9 0,13.9 -0.2,15.4 -2.9,22.8 -3.9,10.9 -6.6,15.9 -11.3,21 -2.2,2.4 -3.8,4.4 -3.5,4.4 3,0 20.2,-10.9 30.5,-19.2 7.5,-6.2 15.4,-15.3 21.5,-24.9 7.4,-11.7 14.2,-32.2 16.6,-50 1.4,-10.4 1.4,-30.3 0.1,-37.8 -0.5,-3.1 -1.4,-8.7 -2,-12.6 -3.9,-24.6 -11.7,-47.9 -25.4,-75.4 l -6.1,-12.3 -1.1,5.8 c -2.7,14.8 -8.5,28.1 -15.5,35.9 -1.9,2 -3.8,4.3 -4.2,5.1 -0.5,0.8 -2.4,1.4 -4.7,1.4 h -3.9 l -0.5,-11.2 c -0.9,-22.5 -4.6,-41.6 -13.5,-70.3 -1.7,-5.5 -3.7,-11.3 -4.5,-13 -0.8,-1.6 -3.6,-7.7 -6.2,-13.5 -6.4,-14 -16.6,-31 -26.5,-44.3 -8.1,-10.8 -38.3,-42.6 -39.5,-41.4 -0.3,0.3 -0.1,3.7 0.5,7.6 1.4,8.8 1.4,27.8 0.1,41.2 -1,9.8 -5.5,31.2 -7,33.4 -0.4,0.6 -1.7,3.9 -2.9,7.5 -5.8,16.9 -17.9,40.4 -37.9,73.1 -35.9,59.1 -47,87.5 -46,117.5 -1.13387,10.92664 1.33389,18.49071 4.3,28.2 0.7,4.1 6.7,17.1 10.9,24 8.8,14.3 16.6,22.6 29.6,31.7 5.3,3.8 23,14.5 23.9,14.5 0.3,0 -0.9,-1.5 -2.5,-3.2 z"/><path fill="#ffffff" d="M 214,449.9 C 196.4,443.8 172.8,429.7 162,419 149.9,407 141,392.5 135.7,376.2 132.3,365.8 131.91825,359.1414 131.23822,354.55355 130.57499,348.55339 130.74307,352.78951 130.2,341 c -0.7,-32.6 9.5,-58.7 46,-118.9 20,-32.7 32.1,-56.2 37.9,-73.1 1.2,-3.6 2.6,-6.9 2.9,-7.5 0.6,-0.8 4.3,-15.4 5.5,-21.5 2.9,-15.2 2.4,-50 -1,-63.2 -0.5,-1.9 -0.3,-2.8 0.5,-2.8 4.3,0 35,30.7 47.5,47.5 9.3,12.6 19.6,29.9 25.9,43.5 2.6,5.8 5.4,11.9 6.2,13.5 2.2,4.7 12.4,38.3 12.5,41.5 0.1,0.8 0.6,3.5 1.1,6 1.4,6.6 1.7,8.2 2.3,11.5 1.3,7.2 1.9,13.7 2.2,24.3 0.4,10.6 0.43215,13.52723 3.07812,9.81562 1.82808,-2.25397 2.44285,-3.2924 3.9893,-5.38079 C 329.92478,241.48198 340.2,224.1 343.1,207.3 c 0.7,-4 1.6,-7.3 2,-7.3 3.2,0 17.9,30.6 26.2,54.5 5.3,15.2 7.3,22.8 9.7,38 0.6,3.9 1.5,9.5 2,12.6 1.3,7.6 1.2,33.4 -0.1,43.8 -2.4,17.8 -9.2,38.3 -16.6,50 -11.4,18 -28.2,32.6 -49.8,43.4 -7.2,3.5 -22.8,9.7 -24.7,9.7 -2,0 -0.4,-2 4,-4.8 6.7,-4.3 18.5,-16.4 21.6,-22.3 1.5,-2.6 4,-8.6 5.7,-13.1 2.7,-7.6 3,-9.3 2.8,-20.3 -0.1,-7.4 -1.27693,-14.11666 -1.5,-15.2 -0.13576,-0.65934 -0.76812,-2.8519 -0.9,-3.3 -0.15764,-0.53565 -6.5,-19.1 -11,-28 -7,-14 -16.3,-28 -18.5,-28 -0.7,0 -3.5,10.7 -4.6,17.8 -0.4,2.3 -1.1,4.1 -1.7,3.9 -1.4,-0.4 -7.4,-15.7 -8.7,-22 -0.5,-2.9 -1.6,-7.9 -2.3,-11.2 -1.3,-6.6 -1.7,-36.4 -0.4,-43.2 1.1,-6.3 -0.7,-5.6 -10.9,3.9 -11.1,10.5 -13.6,13.2 -20.6,22.9 -9.3,13 -14.5,25.2 -18.8,44.2 -1.2,5.3 -2.6,9.7 -3.1,9.7 -1.9,0 -6.68637,-10.67526 -7.8,-21.8 -0.62999,-6.29332 -0.81865,-6.76277 -1.84194,-5.46291 C 203.39404,327.17445 194.825,348 191.8125,356.5 c -1.21896,3.54799 -1.83549,5.50427 -3.1625,10.675 -1.35,6.5625 -3.45,26.325 -1.75,35.025 1.8,9.2 6.9,21.5 11.1,27.3 3.8,5.2 12.3,13.5 17.4,17 8.5,6 8.2,6.8 -1.4,3.4 z"/></svg></div>
      <div class="auth-logo-name" id="authAppName">Plynograf</div>
    </div>
    <div class="auth-tabs">
      <button class="auth-tab active" id="tabLogin">PÅ™ihlÃ¡sit se</button>
      <button class="auth-tab" id="tabRegister">Registrovat</button>
    </div>
    <div class="auth-field">
      <label class="auth-label">E-mail</label>
      <input type="email" class="auth-input" id="authEmail" name="email" autocomplete="email" placeholder="vas@email.cz">
    </div>
    <div class="auth-field">
      <label class="auth-label">Heslo</label>
      <input type="password" class="auth-input" id="authPassword" name="password" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
    </div>
    <div class="auth-err" id="authErr"></div>
    <button class="auth-btn" id="authSubmit">PÅ™ihlÃ¡sit se</button>
    <div class="auth-success" id="authSuccess"></div>
  </div>
</div>

<!-- LOADING -->
<div id="loadingOverlay"><div class="loading-spinner"></div></div>

<div id="header">
  <div class="logo">
    <div class="logo-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="26" height="26" style="display:block;"><path fill="#f97316" d="M 0,256 V 0 H 256 512 V 256 512 H 256 0 Z m 199.4,181.8 c -7.5,-8.1 -12.9,-19.6 -15.5,-32.6 -1.8,-9.4 -0.7,-34.1 1.9,-40.7 1,-2.7 2.5,-7.5 3.2,-10.5 1.4,-6.5 12.5,-29.4 17.5,-36.2 3,-4.1 4.375,-5.7375 7.375,-5.7375 2.8,0 2.85,-1.225 3.525,3.2375 0.3,1.2 0.7,3.3 1,4.7 1.5,7.4 3.3,13.3 3.8,12.5 0.3,-0.6 1.1,-3.5 1.8,-6.5 3.3,-14.5 9.3,-28 17.8,-39.9 7,-9.7 9.5,-12.4 20.6,-22.8 8.3,-7.9 9,-8.3 13.3,-8.3 h 4.5 l -0.6,5.3 c -1.5,14 -1.8,32 -0.6,38 2.5,12.8 3.3,16.4 5.3,23 2.3,7.3 2.7,7.2 4.7,-1.5 1.3,-5.8 1.3,-5.8 5,-5.8 4.3,0 5.8,1.4 12.3,11.5 7.1,11.1 14.3,26.3 18.7,39.4 4,11.9 4,12.2 4,26.9 0,13.9 -0.2,15.4 -2.9,22.8 -3.9,10.9 -6.6,15.9 -11.3,21 -2.2,2.4 -3.8,4.4 -3.5,4.4 3,0 20.2,-10.9 30.5,-19.2 7.5,-6.2 15.4,-15.3 21.5,-24.9 7.4,-11.7 14.2,-32.2 16.6,-50 1.4,-10.4 1.4,-30.3 0.1,-37.8 -0.5,-3.1 -1.4,-8.7 -2,-12.6 -3.9,-24.6 -11.7,-47.9 -25.4,-75.4 l -6.1,-12.3 -1.1,5.8 c -2.7,14.8 -8.5,28.1 -15.5,35.9 -1.9,2 -3.8,4.3 -4.2,5.1 -0.5,0.8 -2.4,1.4 -4.7,1.4 h -3.9 l -0.5,-11.2 c -0.9,-22.5 -4.6,-41.6 -13.5,-70.3 -1.7,-5.5 -3.7,-11.3 -4.5,-13 -0.8,-1.6 -3.6,-7.7 -6.2,-13.5 -6.4,-14 -16.6,-31 -26.5,-44.3 -8.1,-10.8 -38.3,-42.6 -39.5,-41.4 -0.3,0.3 -0.1,3.7 0.5,7.6 1.4,8.8 1.4,27.8 0.1,41.2 -1,9.8 -5.5,31.2 -7,33.4 -0.4,0.6 -1.7,3.9 -2.9,7.5 -5.8,16.9 -17.9,40.4 -37.9,73.1 -35.9,59.1 -47,87.5 -46,117.5 -1.13387,10.92664 1.33389,18.49071 4.3,28.2 0.7,4.1 6.7,17.1 10.9,24 8.8,14.3 16.6,22.6 29.6,31.7 5.3,3.8 23,14.5 23.9,14.5 0.3,0 -0.9,-1.5 -2.5,-3.2 z"/><path fill="#ffffff" d="M 214,449.9 C 196.4,443.8 172.8,429.7 162,419 149.9,407 141,392.5 135.7,376.2 132.3,365.8 131.91825,359.1414 131.23822,354.55355 130.57499,348.55339 130.74307,352.78951 130.2,341 c -0.7,-32.6 9.5,-58.7 46,-118.9 20,-32.7 32.1,-56.2 37.9,-73.1 1.2,-3.6 2.6,-6.9 2.9,-7.5 0.6,-0.8 4.3,-15.4 5.5,-21.5 2.9,-15.2 2.4,-50 -1,-63.2 -0.5,-1.9 -0.3,-2.8 0.5,-2.8 4.3,0 35,30.7 47.5,47.5 9.3,12.6 19.6,29.9 25.9,43.5 2.6,5.8 5.4,11.9 6.2,13.5 2.2,4.7 12.4,38.3 12.5,41.5 0.1,0.8 0.6,3.5 1.1,6 1.4,6.6 1.7,8.2 2.3,11.5 1.3,7.2 1.9,13.7 2.2,24.3 0.4,10.6 0.43215,13.52723 3.07812,9.81562 1.82808,-2.25397 2.44285,-3.2924 3.9893,-5.38079 C 329.92478,241.48198 340.2,224.1 343.1,207.3 c 0.7,-4 1.6,-7.3 2,-7.3 3.2,0 17.9,30.6 26.2,54.5 5.3,15.2 7.3,22.8 9.7,38 0.6,3.9 1.5,9.5 2,12.6 1.3,7.6 1.2,33.4 -0.1,43.8 -2.4,17.8 -9.2,38.3 -16.6,50 -11.4,18 -28.2,32.6 -49.8,43.4 -7.2,3.5 -22.8,9.7 -24.7,9.7 -2,0 -0.4,-2 4,-4.8 6.7,-4.3 18.5,-16.4 21.6,-22.3 1.5,-2.6 4,-8.6 5.7,-13.1 2.7,-7.6 3,-9.3 2.8,-20.3 -0.1,-7.4 -1.27693,-14.11666 -1.5,-15.2 -0.13576,-0.65934 -0.76812,-2.8519 -0.9,-3.3 -0.15764,-0.53565 -6.5,-19.1 -11,-28 -7,-14 -16.3,-28 -18.5,-28 -0.7,0 -3.5,10.7 -4.6,17.8 -0.4,2.3 -1.1,4.1 -1.7,3.9 -1.4,-0.4 -7.4,-15.7 -8.7,-22 -0.5,-2.9 -1.6,-7.9 -2.3,-11.2 -1.3,-6.6 -1.7,-36.4 -0.4,-43.2 1.1,-6.3 -0.7,-5.6 -10.9,3.9 -11.1,10.5 -13.6,13.2 -20.6,22.9 -9.3,13 -14.5,25.2 -18.8,44.2 -1.2,5.3 -2.6,9.7 -3.1,9.7 -1.9,0 -6.68637,-10.67526 -7.8,-21.8 -0.62999,-6.29332 -0.81865,-6.76277 -1.84194,-5.46291 C 203.39404,327.17445 194.825,348 191.8125,356.5 c -1.21896,3.54799 -1.83549,5.50427 -3.1625,10.675 -1.35,6.5625 -3.45,26.325 -1.75,35.025 1.8,9.2 6.9,21.5 11.1,27.3 3.8,5.2 12.3,13.5 17.4,17 8.5,6 8.2,6.8 -1.4,3.4 z"/></svg></div>
    <div>
      <div class="logo-title" data-i18n="appName">Plynograf</div>
      <div class="logo-sub" id="logoSub">MÄ›Å™ Â· Sleduj Â· Å etÅ™i</div>
    </div>
  </div>
  <div class="header-right">
    <button class="btn-theme" id="themeBtn" title="PÅ™epnout tÃ©ma">â˜€ï¸</button>
    <div class="lang-toggle">
      <button class="lang-btn active" data-lang="cs">CZ</button>
      <button class="lang-btn" data-lang="en">EN</button>
    </div>
    <div class="unit-toggle">
      <button class="unit-btn active" data-unit="m3">mÂ³</button>
      <button class="unit-btn" data-unit="kwh">kWh</button>
    </div>
    <div class="user-menu" id="userMenu" style="display:none">
      <div class="user-badge" id="userBadge">
        <span>ğŸ‘¤</span>
      </div>
      <div class="user-dropdown" id="userDropdown">
        <div class="user-dropdown-email" id="userEmailFull">â€“</div>
        <button class="user-dropdown-btn" id="btnLogout">â» &nbsp;OdhlÃ¡sit se</button>
      </div>
    </div>
  </div>
</div>

<div id="tabs">
  <button class="tab active" data-tab="charts">ğŸ“Š Grafy</button>
  <button class="tab" data-tab="readings">âœï¸ OdeÄty</button>
  <button class="tab" data-tab="netatmo">ğŸ“¡ Netatmo</button>
</div>

<div id="content">

  <!-- CHARTS -->
  <div class="screen active" id="screen-charts">
    <div class="stat-cards" id="statCards"></div>
    <div id="weakAlert"></div>
    <div class="chart-mode-toggle">
      <button class="chart-mode-btn active" id="btnModeMonthly" data-mode="monthly">â€“</button>
      <button class="chart-mode-btn" id="btnModeDaily" data-mode="daily">â€“</button>
      <button class="chart-mode-btn" id="btnModeHourly" data-mode="hourly">â€“</button>
    </div>
    <div class="year-pills" id="yearPills"></div>
    <div class="month-pills" id="monthPills" style="display:none"></div>
    <div class="chart-wrap" id="chartWrap">
      <div class="chart-title" id="chartTitle"></div>
      <div id="chartSvgContainer"></div>
      <div class="chart-legend" id="chartLegend"></div>
    </div>
    <div class="info-box" id="infoBox"></div>
  </div>

  <!-- READINGS -->
  <div class="screen" id="screen-readings">
    <div class="panel" style="margin-bottom:16px;">
      <div class="panel-header"><span data-i18n="readingsTitle">NOVÃ ODEÄŒET PLYNOMÄšRU</span></div>
      <div class="panel-body">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label"><span data-i18n="labelDate">Datum</span></label>
            <input type="date" class="form-input" id="inDate">
          </div>
          <div class="form-group">
            <label class="form-label"><span data-i18n="labelValue">Stav plynomÄ›ru (mÂ³)</span></label>
            <input type="number" class="form-input" id="inValue" placeholder="napÅ™. 14 200" style="width:150px">
          </div>
          <div class="form-group" style="flex:1;min-width:100px;">
            <label class="form-label"><span data-i18n="labelNote">PoznÃ¡mka</span></label>
            <input type="text" class="form-input" id="inNote" placeholder="volitelnÃ©" style="width:100%">
          </div>
          <button class="btn-add" id="btnAdd">+ PÅ™idat</button>
        </div>
        <div class="error-text" id="addErr" style="display:none"></div>
      </div>
    </div>
    <div class="panel">
      <div class="panel-header" style="border-bottom:none;"><span id="readingsCount">ODEÄŒTY</span><span class="hint" data-i18n="hintEnter">Enter = rychlÃ© pÅ™idÃ¡nÃ­</span></div>
      <div style="max-height:420px;overflow-y:auto;overscroll-behavior:contain;" id="readingsList"></div>
    </div>
  </div>

  <!-- NETATMO -->
  <div class="screen" id="screen-netatmo">
    <div class="upload-zone" id="uploadZone">
      <input type="file" accept=".csv" id="fileInput" style="display:none">
      <div class="upload-icon">ğŸ“¡</div>
      <div class="upload-title" id="uploadTitle">NahrÃ¡t Netatmo Energy CSV</div>
      <div class="upload-desc" id="uploadDesc">KaÅ¾dÃ½ CSV se <strong>automaticky slouÄÃ­</strong> s pÅ™edchozÃ­mi daty<br>PÅ™ekryvy OK Â· Mezery = lineÃ¡rnÃ­ fallback Â· LibovolnÃ© poÅ™adÃ­</div>
      <div class="upload-badges" id="uploadBadges">
        <span class="upload-badge">âœ“ PÅ™ekryvy</span>
        <span class="upload-badge">âœ“ Mezery</span>
        <span class="upload-badge">âœ“ Duplicity</span>
        <span class="upload-badge">âœ“ PoÅ™adÃ­</span>
      </div>
      <div class="btn-upload" id="btnUploadLabel">+ PÅ™idat CSV soubor</div>
    </div>
    <div id="importAlert"></div>
    <div id="coverageWrap"></div>
    <div id="howtoWrap"></div>
  </div>

</div>

<script>
// â”€â”€ SUPABASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUPABASE_URL = "https://wpfhuaeoacmrnulprhfh.supabase.co";
const SUPABASE_KEY = "sb_publishable_QaWzVGOMa6-9MDgVFeyeSQ_QJrm4mMp";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;

// â”€â”€ AUTH FUNCTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadUserData() {
  if (!currentUser) return;
  showLoading(true);
  try {
    // Load readings
    const {data: rData, error: rErr} = await sb.from("readings").select("*").order("date");
    if (!rErr && rData.length > 0) {
      readings = rData.map(r => ({
        id: r.id, date: r.date, value: parseFloat(r.value), note: r.note||""
      }));
    }
    // Load netatmo days
    const {data: nData, error: nErr} = await sb.from("netatmo_days").select("*").order("date");
    if (!nErr && nData.length > 0) {
      netatmoDays = nData.map(d => ({
        date: d.date, boilerOnSeconds: parseFloat(d.boiler_on_seconds),
        boilerOnHours: Math.round(parseFloat(d.boiler_on_seconds)/3600*10)/10,
        avgTemp: d.avg_temp ? parseFloat(d.avg_temp) : null
      }));
    }
  } catch(e) { console.error("Load error:", e); }
  showLoading(false);
  renderAll();
}

async function saveReading(r) {
  if (!currentUser) return;
  const isNew = typeof r.id === "number"; // ÄÃ­selnÃ© = doÄasnÃ© lokÃ¡lnÃ­ ID, jeÅ¡tÄ› nenÃ­ v DB
  if (isNew) {
    // INSERT â€” vrÃ¡tÃ­ novÃ½ Å™Ã¡dek s UUID
    const {data, error} = await sb.from("readings").insert({
      user_id: currentUser.id,
      date: r.date, value: r.value, note: r.note||""
    }).select().single();
    if (error) { console.error("Insert error:", error); return; }
    // NahraÄ doÄasnÃ© ÄÃ­selnÃ© ID UUID-Äkem z DB
    readings = readings.map(x => x.id === r.id ? {...x, id: data.id} : x);
    if (pendingDelId === r.id) pendingDelId = data.id;
    if (editingId === r.id) editingId = data.id;
  } else {
    // UPDATE â€” existujÃ­cÃ­ zÃ¡znam s UUID
    const {error} = await sb.from("readings").update({
      date: r.date, value: r.value, note: r.note||""
    }).eq("id", r.id);
    if (error) console.error("Update error:", error);
  }
}

async function deleteReading(id) {
  if (!currentUser || typeof id === "number") return; // ÄÃ­selnÃ© = jen lokÃ¡lnÃ­, nic v DB
  const {error} = await sb.from("readings").delete().eq("id", id);
  if (error) console.error("Delete error:", error);
}

async function saveNetatmoDays(days) {
  if (!currentUser || !days.length) return;
  const rows = days.map(d => ({
    user_id: currentUser.id,
    date: d.date,
    boiler_on_seconds: d.boilerOnSeconds,
    avg_temp: d.avgTemp
  }));
  await sb.from("netatmo_days").upsert(rows, {onConflict: "user_id,date"});
}

async function clearNetatmoCloud() {
  if (!currentUser) return;
  await sb.from("netatmo_days").delete().eq("user_id", currentUser.id);
}

function showLoading(v) {
  document.getElementById("loadingOverlay").style.display = v ? "flex" : "none";
}

function showApp(user) {
  currentUser = user;
  document.getElementById("authScreen").style.display = "none";
  document.getElementById("userMenu").style.display = "flex";
  const email = user.email || "";
  document.getElementById("userEmailFull").textContent = email;
  // Clear seed data for real users
  readings = [];
  netatmoDays = [];
  loadUserData();
}

function showAuth() {
  currentUser = null;
  document.getElementById("authScreen").style.display = "flex";
  document.getElementById("userMenu").style.display = "none";
}

// â”€â”€ AUTH EVENT HANDLERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let authMode = "login";

document.getElementById("tabLogin").addEventListener("click", () => {
  authMode = "login";
  document.getElementById("tabLogin").classList.add("active");
  document.getElementById("tabRegister").classList.remove("active");
  document.getElementById("authSubmit").textContent = t("authLogin");
  document.getElementById("authErr").textContent = "";
  document.getElementById("authSuccess").textContent = "";
});

document.getElementById("tabRegister").addEventListener("click", () => {
  authMode = "register";
  document.getElementById("tabRegister").classList.add("active");
  document.getElementById("tabLogin").classList.remove("active");
  document.getElementById("authSubmit").textContent = t("authRegister");
  document.getElementById("authErr").textContent = "";
  document.getElementById("authSuccess").textContent = "";
});

document.getElementById("authSubmit").addEventListener("click", async () => {
  const email = document.getElementById("authEmail").value.trim();
  const password = document.getElementById("authPassword").value;
  const errEl = document.getElementById("authErr");
  const successEl = document.getElementById("authSuccess");
  const btn = document.getElementById("authSubmit");
  errEl.textContent = ""; successEl.textContent = "";
  if (!email || !password) { errEl.textContent = t("authErrFill"); return; }
  btn.disabled = true; showLoading(true);
  if (authMode === "login") {
    const {data, error} = await sb.auth.signInWithPassword({email, password});
    showLoading(false); btn.disabled = false;
    if (error) { errEl.textContent = t("authErrInvalid"); return; }
    showApp(data.user);
  } else {
    const {data, error} = await sb.auth.signUp({email, password});
    showLoading(false); btn.disabled = false;
    if (error) { errEl.textContent = error.message; return; }
    successEl.textContent = t("authSuccessRegister");
  }
});

document.getElementById("authEmail").addEventListener("keydown", e => { if(e.key==="Enter") document.getElementById("authPassword").focus(); });
document.getElementById("authPassword").addEventListener("keydown", e => { if(e.key==="Enter") document.getElementById("authSubmit").click(); });

// Dropdown toggle
document.getElementById("userBadge").addEventListener("click", (e) => {
  e.stopPropagation();
  const dd = document.getElementById("userDropdown");
  dd.classList.toggle("open");
  document.getElementById("userChevron").textContent = dd.classList.contains("open") ? "â–´" : "â–¾";
});

// Close dropdown when clicking outside
document.addEventListener("click", () => {
  const dd = document.getElementById("userDropdown");
  if (dd) { dd.classList.remove("open"); document.getElementById("userChevron").textContent = "â–¾"; }
});

// Logout button
document.getElementById("btnLogout").addEventListener("click", async (e) => {
  e.stopPropagation();
  await sb.auth.signOut();
  readings = []; netatmoDays = [];
  document.getElementById("userDropdown").classList.remove("open");
  showAuth();
});

// Check existing session on load
sb.auth.getSession().then(({ data: { session } }) => {
  if (session) { showApp(session.user); }
  else { showAuth(); renderAll(); }
});

// â”€â”€ DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const KWH = 10.55;
const MO_SHORT = () => T[lang].monthsShort;
const MO_LONG  = () => T[lang].months;

const YP = {
  dark:  {2023:"#3b82f6",2024:"#10b981",2025:"#a855f7",2026:"#f97316"},
  light: {2023:"#2563eb",2024:"#059669",2025:"#7c3aed",2026:"#d95f00"},
};

let readings = []; // data se naÄtou z Supabase po pÅ™ihlÃ¡Å¡enÃ­
let nextId = 200;
let pendingDelId = null;  // ID ÄekajÃ­cÃ­ na potvrzenÃ­ smazÃ¡nÃ­
let editingId = null;     // ID prÃ¡vÄ› editovanÃ©ho odeÄtu
let netatmoDays = [];
let selHourlyYear = new Date().getFullYear(); // vybranÃ½ rok pro dennÃ­ pohled (radio)
// Verze v patiÄce
document.addEventListener("DOMContentLoaded",()=>{
  const v=document.getElementById("appVersion");
  if(v) v.textContent=APP_VERSION;
});
let unit = "m3";
let theme = "dark";
let lang = "cs";
const APP_VERSION = "v0.51";
let chartMode = "monthly";
let selMonth = 1;
let visYears = (()=>{
  try {
    const saved=localStorage.getItem("plynograf_visYears");
    return saved?JSON.parse(saved):[2024,2025,2026];
  } catch(e){ return [2024,2025,2026]; }
})();

// â”€â”€ NETATMO PARSER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseNetatmoCSV(text) {
  const lines = text.split(/\r?\n/);
  let hi = -1;
  for (let i=0;i<lines.length;i++) { if (lines[i].startsWith("Timestamp")) {hi=i;break;} }
  if (hi===-1) throw new Error("Nenalezen Å™Ã¡dek 'Timestamp'.");
  const db={}, dt={};
  let parsed=0;
  for (let i=hi+1;i<lines.length;i++) {
    const l=lines[i].trim(); if (!l) continue;
    const p=l.split(","); if (p.length<5) continue;
    try {
      const date=p[1].replace(/"/g,"").trim().slice(0,10).replace(/\//g,"-");
      if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) continue;
      const boilerOn=parseFloat(p[4]), temp=parseFloat(p[2]);
      if (isNaN(boilerOn)||isNaN(temp)) continue;
      db[date]=(db[date]||0)+boilerOn;
      if (!dt[date]) dt[date]=[];
      dt[date].push(temp); parsed++;
    } catch(e){}
  }
  const days=Object.keys(db).sort();
  if (!days.length) throw new Error("CSV neobsahuje platnÃ¡ data.");
  return {
    days: days.map(d=>({date:d, boilerOnSeconds:Math.round(db[d]),
      boilerOnHours:Math.round(db[d]/3600*10)/10,
      avgTemp:dt[d]?Math.round(dt[d].reduce((s,v)=>s+v,0)/dt[d].length*10)/10:null,
      records:dt[d]?.length||0})),
    parsed, dateFrom:days[0], dateTo:days[days.length-1]
  };
}

function mergeNetatmo(existing, incoming) {
  const map={};
  for (const d of existing) map[d.date]=d;
  for (const d of incoming) map[d.date]=d;
  return Object.values(map).sort((a,b)=>a.date.localeCompare(b.date));
}

// â”€â”€ INTERPOLATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getBoilerMap() {
  if (!netatmoDays.length) return null;
  const m={};
  for (const d of netatmoDays) m[d.date]=d.boilerOnSeconds;
  return m;
}

function buildDailyMap() {
  const bom=getBoilerMap();
  // Deduplikace - pokud jsou dva zÃ¡znamy ve stejnÃ½ den, ponech jen poslednÃ­
  const dedupMap={};
  for (const r of readings) dedupMap[r.date]=r;
  const sorted=Object.values(dedupMap).sort((a,b)=>new Date(a.date)-new Date(b.date));
  const daily={};
  for (let i=0;i<sorted.length-1;i++) {
    const s=new Date(sorted[i].date), e=new Date(sorted[i+1].date);
    const dc=Math.round((e-s)/86400000);
    if (dc<=0) continue;
    const total=sorted[i+1].value-sorted[i].value;
    if (total<0) continue;
    const days=[];
    // d <= dc aby byl zahrnut i poslednÃ­ den intervalu (den odeÄtu)
    for (let d=0;d<=dc;d++) {
      const day=new Date(s); day.setDate(s.getDate()+d);
      const key=day.toISOString().slice(0,10);
      days.push({key, boiler:bom?.[key]??null});
    }
    const allB=bom&&days.every(d=>d.boiler!==null);
    if (allB) {
      const tb=days.reduce((s,d)=>s+d.boiler,0);
      for (const {key,boiler} of days) daily[key]=tb>0?(boiler/tb)*total:total/dc;
    } else {
      for (const {key} of days) daily[key]=total/dc;
    }
  }
  return daily;
}

function aggregateMonthly(dm) {
  const r={};
  for (const [date,val] of Object.entries(dm)) {
    const [y,m]=date.split("-"); const k=`${y}-${m}`;
    r[k]=(r[k]||0)+val;
  }
  return r;
}

function convert(m3) { return unit==="kwh" ? m3*KWH : m3; }
function ul() { return unit==="m3"?"mÂ³":"kWh"; }

// â”€â”€ TRANSLATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const T = {
  cs: {
    // Header
    appName: "Plynograf",
    logoSubLinear: "MÄ›Å™ Â· Sleduj Â· Å etÅ™i",
    logoSubBoiler: "MÄ›Å™ Â· Sleduj Â· Å etÅ™i",
    // Tabs
    tabCharts: "ğŸ“Š Grafy",
    tabReadings: "âœï¸ OdeÄty",
    tabNetatmo: "ğŸ“¡ Netatmo",
    // Stat cards
    statThisMonth: "Tento mÄ›sÃ­c",
    statVsLastYear: "vs. loni",
    statLastYear: "Loni",
    statInterpolation: "Interpolace",
    statReadings: "OdeÄtÅ¯",
    statIrregular: "nepravidelnÃ©",
    statUploadCSV: "Nahrajte CSV",
    statDays: "dnÃ­",
    // Chart
    chartMonthly: "RoÄnÃ­",
    chartHourly: "DennÃ­",
    chartTitleHourlyPre: "DennÃ­ spotÅ™eba kotle",
    chartDaily: "MÄ›sÃ­ÄnÃ­",
    chartTitleMonthly: "RoÄnÃ­ spotÅ™eba",
    chartTitleDailyPre: "MÄ›sÃ­ÄnÃ­ spotÅ™eba",
    chartBoilerOn: "ğŸŸ¢ BoilerOn",
    chartLinear: "lineÃ¡rnÃ­",
    labelYears: "ROKY:",
    labelMonth: "MÄšSÃC:",
    // Info box
    infoWeighted: "VÃ¡Å¾enÃ¡ interpolace (BoilerOn):",
    infoWeightedDesc: "DennÃ­ spotÅ™eba odpovÃ­dÃ¡ dobÄ› provozu kotle. Dny s delÅ¡Ã­m topenÃ­m majÃ­ vyÅ¡Å¡Ã­ podÃ­l.",
    infoLinear: "LineÃ¡rnÃ­ interpolace:",
    infoLinearDesc: "SpotÅ™eba rovnomÄ›rnÄ› rozdÄ›lena. Nahrajte Netatmo CSV pro pÅ™esnÄ›jÅ¡Ã­ vÃ½sledky.",
    // Weak intervals
    weakAlert: "interval s neÃºplnÃ½mi Netatmo daty:",
    weakAlerts: "intervaly s neÃºplnÃ½mi Netatmo daty:",
    // Readings
    readingsTitle: "NOVÃ ODEÄŒET PLYNOMÄšRU",
    labelDate: "Datum",
    labelValue: "Stav plynomÄ›ru (mÂ³)",
    labelNote: "PoznÃ¡mka",
    placeholderValue: "napÅ™. 14 200",
    placeholderNote: "volitelnÃ©",
    btnAdd: "+ PÅ™idat",
    readingsCount: "ODEÄŒTY â€” {n} zÃ¡znamÅ¯",
    hintEnter: "Enter = rychlÃ© pÅ™idÃ¡nÃ­",
    errFillAll: "VyplÅˆte datum i hodnotu.",
    errInvalidVal: "NeplatnÃ¡ hodnota.",
    errOrder: "Hodnota musÃ­ bÃ½t vÄ›tÅ¡Ã­ neÅ¾ pÅ™edchozÃ­ odeÄet.",
    confirmDelete: "Opravdu smazat tento odeÄet?",
    btnBack: "ZpÄ›t",
    btnDelete: "Smazat",
    btnSave: "âœ“ UloÅ¾it",
    btnCancel: "ZruÅ¡it",
    editErrFill: "VyplÅˆte datum i hodnotu.",
    editErrOrder: "Hodnota by poruÅ¡ila poÅ™adÃ­ odeÄtÅ¯ â€” zkontrolujte ÄÃ­slo.",
    // Netatmo
    uploadTitle: "NahrÃ¡t Netatmo Energy CSV",
    uploadDesc: "KaÅ¾dÃ½ CSV se <strong>automaticky slouÄÃ­</strong> s pÅ™edchozÃ­mi daty<br>PÅ™ekryvy OK Â· Mezery = lineÃ¡rnÃ­ fallback Â· LibovolnÃ© poÅ™adÃ­",
    uploadBadges: ["âœ“ PÅ™ekryvy","âœ“ Mezery","âœ“ Duplicity","âœ“ PoÅ™adÃ­"],
    btnUpload: "+ PÅ™idat CSV soubor",
    importSuccess: "âœ“ Import",
    importDays: "dnÃ­",
    importTotal: "Celkem",
    coverageTitle: "POKRYTÃ NETATMO DAT PER MÄšSÃC",
    btnClearNetatmo: "Vymazat Netatmo data",
    howtoTitle: "Jak exportovat z Netatmo Energy:",
    howtoSteps: [
      "OtevÅ™ete Netatmo Energy (web nebo app)",
      "NastavenÃ­ â†’ SprÃ¡va dat â†’ StÃ¡hnout historii",
      "Zvolte ÄasovÃ© obdobÃ­ â†’ Export CSV",
      "Nahrajte sem â€” opakujte pro kaÅ¾dÃ© obdobÃ­"
    ],
    authLogin: "PÅ™ihlÃ¡sit se",
    authRegister: "Registrovat",
    authErrFill: "VyplÅˆte e-mail a heslo.",
    authErrInvalid: "Å patnÃ½ e-mail nebo heslo.",
    authSuccessRegister: "ÃšÄet vytvoÅ™en! Zkontrolujte e-mail pro potvrzenÃ­.",
    authLogout: "OdhlÃ¡sit se",
    authLogoutConfirm: "Opravdu se chcete odhlÃ¡sit?",
    months: ["Leden","Ãšnor","BÅ™ezen","Duben","KvÄ›ten","ÄŒerven","ÄŒervenec","Srpen","ZÃ¡Å™Ã­","Å˜Ã­jen","Listopad","Prosinec"],
    monthsShort: ["Led","Ãšno","BÅ™e","Dub","KvÄ›","ÄŒvn","ÄŒvc","Srp","ZÃ¡Å™","Å˜Ã­j","Lis","Pro"],
  },
  en: {
    appName: "GasChart",
    logoSubLinear: "Measure Â· Track Â· Save",
    logoSubBoiler: "Measure Â· Track Â· Save",
    tabCharts: "ğŸ“Š Charts",
    tabReadings: "âœï¸ Readings",
    tabNetatmo: "ğŸ“¡ Netatmo",
    statThisMonth: "This month",
    statVsLastYear: "vs. last year",
    statLastYear: "Last year",
    statInterpolation: "Interpolation",
    statReadings: "Readings",
    statIrregular: "irregular",
    statUploadCSV: "Upload CSV",
    statDays: "days",
    chartMonthly: "Yearly",
    chartHourly: "Daily",
    chartTitleHourlyPre: "Daily boiler consumption",
    chartDaily: "Monthly",
    chartTitleMonthly: "Yearly consumption",
    chartTitleDailyPre: "Monthly consumption",
    chartBoilerOn: "ğŸŸ¢ BoilerOn",
    chartLinear: "linear",
    labelYears: "YEARS:",
    labelMonth: "MONTH:",
    infoWeighted: "Weighted interpolation (BoilerOn):",
    infoWeightedDesc: "Daily consumption reflects actual boiler runtime. Days with longer heating get a higher share.",
    infoLinear: "Linear interpolation:",
    infoLinearDesc: "Consumption spread evenly between readings. Upload Netatmo CSV for more accurate results.",
    weakAlert: "interval with incomplete Netatmo data:",
    weakAlerts: "intervals with incomplete Netatmo data:",
    readingsTitle: "NEW METER READING",
    labelDate: "Date",
    labelValue: "Meter reading (mÂ³)",
    labelNote: "Note",
    placeholderValue: "e.g. 14 200",
    placeholderNote: "optional",
    btnAdd: "+ Add",
    readingsCount: "READINGS â€” {n} entries",
    hintEnter: "Enter = quick add",
    errFillAll: "Please fill in date and value.",
    errInvalidVal: "Invalid value.",
    errOrder: "Value must be greater than the previous reading.",
    confirmDelete: "Really delete this reading?",
    btnBack: "Back",
    btnDelete: "Delete",
    btnSave: "âœ“ Save",
    btnCancel: "Cancel",
    editErrFill: "Please fill in date and value.",
    editErrOrder: "Value would break reading order â€” please check the number.",
    uploadTitle: "Upload Netatmo Energy CSV",
    uploadDesc: "Each CSV is <strong>automatically merged</strong> with previously uploaded data<br>Overlaps OK Â· Gaps = linear fallback Â· Any order",
    uploadBadges: ["âœ“ Overlaps","âœ“ Gaps","âœ“ Duplicates","âœ“ Any order"],
    btnUpload: "+ Add CSV file",
    importSuccess: "âœ“ Imported",
    importDays: "days",
    importTotal: "Total",
    coverageTitle: "NETATMO DATA COVERAGE PER MONTH",
    btnClearNetatmo: "Clear Netatmo data",
    howtoTitle: "How to export from Netatmo Energy:",
    howtoSteps: [
      "Open Netatmo Energy (web or app)",
      "Settings â†’ Data management â†’ Download history",
      "Choose a time period â†’ Export CSV",
      "Upload here â€” repeat for each period"
    ],
    authLogin: "Sign in",
    authRegister: "Register",
    authErrFill: "Please fill in email and password.",
    authErrInvalid: "Invalid email or password.",
    authSuccessRegister: "Account created! Check your email to confirm.",
    authLogout: "Sign out",
    authLogoutConfirm: "Are you sure you want to sign out?",
    months: ["January","February","March","April","May","June","July","August","September","October","November","December"],
    monthsShort: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
  }
};
function t(key, vars) {
  const str = T[lang][key] ?? T["cs"][key] ?? key;
  if (!vars) return str;
  return str.replace(/\{(\w+)\}/g, (_,k) => vars[k] ?? "");
}

// â”€â”€ SVG BAR CHART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBarChart() {
  const dm=buildDailyMap(), mm=aggregateMonthly(dm);
  const palette=YP[theme];
  const container=document.getElementById("chartSvgContainer");
  const W=container.offsetWidth||document.getElementById("chartWrap").offsetWidth-32||window.innerWidth-64;
  const H=220, PL=48, PR=8, PT=10, PB=30;
  const cW=W-PL-PR, cH=H-PT-PB;

  // gather data
  const data=MO_SHORT().map((label,mi)=>{
    const row={label,mi};
    for (const y of visYears) {
      const key=`${y}-${String(mi+1).padStart(2,"0")}`;
      row[y]=mm[key]!=null?convert(mm[key]):null;
    }
    return row;
  });

  const allVals=data.flatMap(r=>visYears.map(y=>r[y]).filter(v=>v!=null));
  const maxV=allVals.length?Math.max(...allVals)*1.1:10;

  const barW=Math.max(4, (cW/12 - visYears.length*2) / visYears.length);
  const groupW=cW/12;

  let bars="", labels="", yLines="";

  // Y grid lines
  const ticks=4;
  for (let t=0;t<=ticks;t++) {
    const val=maxV*t/ticks;
    const y=PT+cH-(cH*t/ticks);
    yLines+=`<line x1="${PL}" y1="${y}" x2="${W-PR}" y2="${y}" stroke="${theme==="dark"?"#21262d":"#e5e7eb"}" stroke-dasharray="2,4"/>`;
    yLines+=`<text x="${PL-4}" y="${y+4}" text-anchor="end" font-size="9" fill="${theme==="dark"?"#6e7681":"#6e7781"}">${val>=100?Math.round(val):val.toFixed(1)}</text>`;
  }

  // bars
  data.forEach((row,mi)=>{
    const gx=PL+mi*groupW;
    // label
    labels+=`<text x="${gx+groupW/2}" y="${H-8}" text-anchor="middle" font-size="9" fill="${theme==="dark"?"#6e7681":"#6e7781"}">${row.label}</text>`;
    visYears.forEach((y,yi)=>{
      if (row[y]==null) return;
      const bh=Math.max(2,(row[y]/maxV)*cH);
      const bx=gx+(yi*(barW+2))+(groupW-visYears.length*(barW+2))/2;
      const by=PT+cH-bh;
      const color=palette[y]||"#94a3b8";
      bars+=`<rect x="${bx}" y="${by}" width="${barW}" height="${bh}" fill="${color}" rx="2" opacity="0.9">
        <title>${y}: ${row[y].toFixed(1)} ${ul()}</title></rect>`;
    });
  });

  document.getElementById("chartSvgContainer").innerHTML=
    `<svg width="100%" height="${H}" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">
      ${yLines}${bars}${labels}
    </svg>`;
}

// â”€â”€ SVG AREA CHART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAreaChart() {
  const dm=buildDailyMap();
  const palette=YP[theme];
  const container=document.getElementById("chartSvgContainer");
  const W=container.offsetWidth||document.getElementById("chartWrap").offsetWidth-32||window.innerWidth-64;
  const H=220, PL=48, PR=8, PT=10, PB=30;
  const cW=W-PL-PR, cH=H-PT-PB;

  // SkuteÄnÃ½ poÄet dnÃ­ ve vybranÃ©m mÄ›sÃ­ci (funguje pro libovolnÃ½ rok vÄetnÄ› pÅ™estupnÃ½ch)
  const days=new Date(new Date().getFullYear(), selMonth+1, 0).getDate();

  // DneÅ¡nÃ­ datum pro porovnÃ¡nÃ­
  const today=new Date(); today.setHours(0,0,0,0);

  const data=Array.from({length:days},(_,di)=>{
    const d=di+1, row={d};
    for (const y of visYears) {
      const m=String(selMonth+1).padStart(2,"0"), ds=`${y}-${m}-${String(d).padStart(2,"0")}`;
      // Pokud je tento den v budoucnosti, nezobrazuj nic
      const thisDay=new Date(`${ds}T00:00:00`);
      if (thisDay>today) { row[y]=null; continue; }
      let raw=dm[ds]??null;
      // Pokud tento den nemÃ¡ data, hledej nejbliÅ¾Å¡Ã­ pÅ™edchozÃ­ hodnotu v mÄ›sÃ­ci
      if (raw===null) {
        for (let prev=d-1;prev>=1;prev--) {
          const prevDs=`${y}-${m}-${String(prev).padStart(2,"0")}`;
          if (dm[prevDs]!=null) { raw=dm[prevDs]; break; }
        }
      }
      row[y]=raw!==null?convert(raw):null;
    }
    return row;
  });

  const allVals=data.flatMap(r=>visYears.map(y=>r[y]).filter(v=>v!=null));
  const maxV=allVals.length?Math.max(...allVals)*1.15:1;

  let areas="", lines="", yLines="";

  const ticks=4;
  for (let t=0;t<=ticks;t++) {
    const val=maxV*t/ticks;
    const y=PT+cH-(cH*t/ticks);
    yLines+=`<line x1="${PL}" y1="${y}" x2="${W-PR}" y2="${y}" stroke="${theme==="dark"?"#21262d":"#e5e7eb"}" stroke-dasharray="2,4"/>`;
    yLines+=`<text x="${PL-4}" y="${y+4}" text-anchor="end" font-size="9" fill="${theme==="dark"?"#6e7681":"#6e7781"}">${val.toFixed(2)}</text>`;
  }

  // X labels - dynamicky podle poÄtu dnÃ­ v mÄ›sÃ­ci
  let xlabels="";
  const xTicks=[1,5,10,15,20,25,days].filter((v,i,a)=>a.indexOf(v)===i);
  xTicks.forEach(d=>{
    const x=PL+(d-1)/(days-1)*cW;
    xlabels+=`<text x="${x}" y="${H-8}" text-anchor="middle" font-size="9" fill="${theme==="dark"?"#6e7681":"#6e7781"}">${d}</text>`;
  });

  visYears.forEach(y=>{
    const color=palette[y]||"#94a3b8";
    const pts=data.map((r,i)=>({x:PL+i/(days-1)*cW, y:r[y]!=null?PT+cH-(r[y]/maxV)*cH:null}));

    // build path segments (skip nulls)
    let linePath="", areaPath="";
    let seg=[];
    pts.forEach((p,i)=>{
      if (p.y!==null) { seg.push(p); }
      else {
        if (seg.length>1) {
          linePath+=seg.map((pt,j)=>`${j===0?"M":"L"}${pt.x.toFixed(1)},${pt.y.toFixed(1)}`).join(" ")+" ";
          areaPath+=`M${seg[0].x.toFixed(1)},${(PT+cH).toFixed(1)} `+seg.map(pt=>`L${pt.x.toFixed(1)},${pt.y.toFixed(1)}`).join(" ")+` L${seg[seg.length-1].x.toFixed(1)},${(PT+cH).toFixed(1)} Z `;
        }
        seg=[];
      }
    });
    if (seg.length>1) {
      linePath+=seg.map((pt,j)=>`${j===0?"M":"L"}${pt.x.toFixed(1)},${pt.y.toFixed(1)}`).join(" ");
      areaPath+=`M${seg[0].x.toFixed(1)},${(PT+cH).toFixed(1)} `+seg.map(pt=>`L${pt.x.toFixed(1)},${pt.y.toFixed(1)}`).join(" ")+` L${seg[seg.length-1].x.toFixed(1)},${(PT+cH).toFixed(1)} Z`;
    }

    const gradId=`grad${y}`;
    areas+=`<defs><linearGradient id="${gradId}" x1="0" y1="0" x2="0" y2="1">
      <stop offset="5%" stop-color="${color}" stop-opacity="${theme==="dark"?0.25:0.15}"/>
      <stop offset="95%" stop-color="${color}" stop-opacity="0"/>
    </linearGradient></defs>
    <path d="${areaPath}" fill="url(#${gradId})"/>`;
    lines+=`<path d="${linePath}" fill="none" stroke="${color}" stroke-width="2"/>`;
  });

  document.getElementById("chartSvgContainer").innerHTML=
    `<svg width="100%" height="${H}" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">
      ${yLines}${areas}${lines}${xlabels}
    </svg>`;
}


// â”€â”€ SVG DAILY NETATMO CHART (hodiny topenÃ­ + teplota po dnech) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDailyNetatmoChart() {
  const container=document.getElementById("chartSvgContainer");
  const W=container.offsetWidth||document.getElementById("chartWrap").offsetWidth-32||window.innerWidth-64;
  const H=240, PL=48, PR=48, PT=12, PB=28;
  const cW=W-PL-PR, cH=H-PT-PB;

  // Filtruj netatmo data pro vybranÃ½ mÄ›sÃ­c
  const m=String(selMonth+1).padStart(2,"0");
  // Najdi dostupnÃ© roky pro tento mÄ›sÃ­c v netatmo datech
  const mmStr=`-${m}-`;
  const netatmoYears=[...new Set(netatmoDays.filter(x=>x.date.includes(mmStr)).map(x=>x.date.slice(0,4)))].sort();

  // PouÅ¾ij selHourlyYear - nezÃ¡vislÃ½ stav od visYears
  const netatmoYear = String(selHourlyYear);

  // PoÄet dnÃ­ ve sprÃ¡vnÃ©m roce (dÅ¯leÅ¾itÃ© pro pÅ™estupnÃ© roky a sprÃ¡vnÃ½ mÄ›sÃ­c)
  const days=new Date(parseInt(netatmoYear),selMonth+1,0).getDate();

  const mutedC=theme==="dark"?"#6e7681":"#6e7781";

  const monthData=[];
  for (let d=1;d<=days;d++) {
    const dayStr=`${netatmoYear}-${m}-${String(d).padStart(2,"0")}`;
    const nd=netatmoDays.find(x=>x.date===dayStr);
    monthData.push({d, h: nd?nd.boilerOnHours:null, t: nd?nd.avgTemp:null});
  }

  // Zkontroluj jestli mÃ¡me vÅ¯bec nÄ›jakÃ¡ data
  const hasData=monthData.some(d=>d.h!==null);
  if (!hasData) {
    document.getElementById("chartSvgContainer").innerHTML=
      `<div style="display:flex;align-items:center;justify-content:center;height:200px;color:${theme==="dark"?"#6e7681":"#6e7781"};font-size:13px;font-family:monospace">
        ${lang==="cs"?"Å½Ã¡dnÃ¡ Netatmo data pro tento mÄ›sÃ­c":"No Netatmo data for this month"}
      </div>`;
    return;
  }

  const maxH=Math.max(...monthData.filter(d=>d.h!==null).map(d=>d.h))*1.2;
  const temps=monthData.filter(d=>d.t!==null).map(d=>d.t);
  const minT=temps.length?Math.min(...temps)-0.3:18;
  const maxT=temps.length?Math.max(...temps)+0.3:22;

  const barW=Math.max(4, cW/days*0.7);
  let bars="", tempPath="", yLeft="", yRight="", xLabels="", tempDots="";

  // Y osa vlevo - hodiny topenÃ­
  for (let i=0;i<=4;i++) {
    const val=maxH*i/4;
    const y=PT+cH-(cH*i/4);
    yLeft+=`<line x1="${PL}" y1="${y}" x2="${W-PR}" y2="${y}" stroke="${theme==="dark"?"#21262d":"#e5e7eb"}" stroke-dasharray="2,4"/>`;
    yLeft+=`<text x="${PL-6}" y="${y+4}" text-anchor="end" font-size="9" fill="${theme==="dark"?"#f97316":"#d95f00"}">${val.toFixed(1)}</text>`;
  }

  // Y osa vpravo - teplota
  for (let i=0;i<=4;i++) {
    const val=minT+(maxT-minT)*i/4;
    const y=PT+cH-(cH*i/4);
    yRight+=`<text x="${W-PR+6}" y="${y+4}" text-anchor="start" font-size="9" fill="${theme==="dark"?"#38bdf8":"#0284c7"}">${val.toFixed(1)}Â°</text>`;
  }

  // Sloupce + teplotnÃ­ ÄÃ¡ra
  const tpts=[];
  monthData.forEach((d,i)=>{
    const x=PL+(i+0.5)*cW/days;

    // Sloupec
    if (d.h!==null) {
      const bH=(d.h/maxH)*cH;
      const bY=PT+cH-bH;
      const intensity=d.h/maxH;
      const orange1=theme==="dark"?[249,115,22]:[217,95,0];
      const orange0=theme==="dark"?[30,50,80]:[200,220,240];
      const r=Math.round(orange0[0]+(orange1[0]-orange0[0])*intensity);
      const g=Math.round(orange0[1]+(orange1[1]-orange0[1])*intensity);
      const b=Math.round(orange0[2]+(orange1[2]-orange0[2])*intensity);
      bars+=`<rect x="${(x-barW/2).toFixed(1)}" y="${bY.toFixed(1)}" width="${barW.toFixed(1)}" height="${bH.toFixed(1)}" fill="rgb(${r},${g},${b})" rx="2" opacity="0.9"/>`;
      if (barW>14) bars+=`<text x="${x.toFixed(1)}" y="${(bY-3).toFixed(1)}" text-anchor="middle" font-size="8" fill="${theme==="dark"?"#8b949e":"#57606a"}">${d.h.toFixed(1)}</text>`;
    }

    // Teplota
    if (d.t!==null) {
      const ty=PT+cH-((d.t-minT)/(maxT-minT))*cH;
      tpts.push({x,y:ty});
      tempDots+=`<circle cx="${x.toFixed(1)}" cy="${ty.toFixed(1)}" r="2" fill="${theme==="dark"?"#38bdf8":"#0284c7"}"/>`;
    }

    // X popisky: 1, kaÅ¾dÃ½ 5. den (jen pokud je >=3 dny od konce), a vÅ¾dy poslednÃ­ den
    const tickSet=new Set([1]);
    for (let td=5;td<days;td+=5) { if (days-td>=3) tickSet.add(td); }
    tickSet.add(days);
    if (tickSet.has(d.d))
      xLabels+=`<text x="${x.toFixed(1)}" y="${H-8}" text-anchor="middle" font-size="9" fill="${theme==="dark"?"#6e7681":"#6e7781"}">${d.d}.</text>`;
  });

  if (tpts.length>1)
    tempPath=`<polyline points="${tpts.map(p=>`${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(" ")}" fill="none" stroke="${theme==="dark"?"#38bdf8":"#0284c7"}" stroke-width="1.5" stroke-linejoin="round"/>`;

  // Popisky os
  const labelH=Math.round(PT+cH/2);
  const axisL=`<text x="${PL-36}" y="${labelH}" text-anchor="middle" font-size="9" fill="${theme==="dark"?"#f97316":"#d95f00"}" transform="rotate(-90,${PL-36},${labelH})">${lang==="cs"?"TopenÃ­ (h)":"Heating (h)"}</text>`;
  const axisR=`<text x="${W-PR+36}" y="${labelH}" text-anchor="middle" font-size="9" fill="${theme==="dark"?"#38bdf8":"#0284c7"}" transform="rotate(90,${W-PR+36},${labelH})">${lang==="cs"?"Teplota (Â°C)":"Temp (Â°C)"}</text>`;

  document.getElementById("chartSvgContainer").innerHTML=
    `<svg width="100%" height="${H}" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">
      ${yLeft}${yRight}${bars}${tempPath}${tempDots}${xLabels}${axisL}${axisR}
    </svg>`;

  // Klik na rok

}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function availableYears() {
  return [...new Set(readings.map(r=>new Date(r.date).getFullYear()))].sort();
}

function renderAll() {
  const bom=getBoilerMap();
  const useBoiler=!!bom;
  const palette=YP[theme];

  // Logo sub
  // Auth screen labels
  const authAppNameEl = document.getElementById("authAppName");
  if (authAppNameEl) authAppNameEl.textContent = t("appName");
  const tabLoginEl = document.getElementById("tabLogin");
  const tabRegEl = document.getElementById("tabRegister");
  if (tabLoginEl) tabLoginEl.textContent = t("authLogin");
  if (tabRegEl) tabRegEl.textContent = t("authRegister");
  const authBtn = document.getElementById("authSubmit");
  if (authBtn) authBtn.textContent = authMode==="login" ? t("authLogin") : t("authRegister");
  const logoutBtn = document.getElementById("btnLogout");
  if (logoutBtn) logoutBtn.innerHTML = "â» &nbsp;" + t("authLogout");

  document.getElementById("logoSub").textContent=
    useBoiler ? t("logoSubBoiler",{n:netatmoDays.length}) : t("logoSubLinear");

  // Tab labels
  document.querySelector('[data-tab="charts"]').textContent=t("tabCharts");
  document.querySelector('[data-tab="readings"]').textContent=t("tabReadings");
  document.querySelector('[data-tab="netatmo"]').textContent=
    t("tabNetatmo")+(netatmoDays.length?` (${netatmoDays.length}d)`:"");

  // Theme
  document.body.className=theme==="light"?"light":"";
  document.title=t("appName");
  document.getElementById("themeBtn").textContent=theme==="dark"?"â˜€ï¸":"ğŸŒ™";
  document.getElementById("themeColor").content=theme==="dark"?"#010409":"#f6f8fa";

  // Netatmo tab label
  document.querySelector('[data-tab="netatmo"]').textContent=
    `ğŸ“¡ Netatmo${netatmoDays.length?` (${netatmoDays.length}d)`:""}`;

  // â”€â”€ STATS
  const dm=buildDailyMap(), mm=aggregateMonthly(dm);
  const now=new Date();
  const curKey=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
  const prevKey=`${now.getFullYear()-1}-${String(now.getMonth()+1).padStart(2,"0")}`;
  const cur=convert(mm[curKey]||0), prev=convert(mm[prevKey]||0);
  const pct=prev>0?Math.round(((cur-prev)/prev)*100):null;
  const diffColor=pct===null?(theme==="dark"?"#6e7681":"#6e7781"):pct<0?(theme==="dark"?"#3fb950":"#0a8c5a"):(theme==="dark"?"#f85149":"#b91c1c");
  const diffLabel=pct===null?"â€“":`${pct<0?"â–¼":"â–²"} ${Math.abs(pct)}%`;
  const accentColor=theme==="dark"?"#f97316":"#d95f00";
  const successColor=theme==="dark"?"#34d399":"#0a8c5a";
  const mutedColor=theme==="dark"?"#8b949e":"#57606a";

  document.getElementById("statCards").innerHTML=[
    {label:t("statThisMonth"),value:`${cur.toFixed(1)} ${ul()}`,color:accentColor},
    {label:t("statVsLastYear"),value:diffLabel,color:diffColor,sub:`${t("statLastYear")}: ${prev.toFixed(1)} ${ul()}`},
    {label:t("statInterpolation"),value:useBoiler?"BoilerOn âœ“":(lang==="cs"?"LineÃ¡rnÃ­":"Linear"),color:useBoiler?successColor:mutedColor,sub:useBoiler?`${netatmoDays.length} ${t("statDays")}`:t("statUploadCSV")},
    {label:t("statReadings"),value:readings.length,color:"",sub:t("statIrregular")},
  ].map(c=>`<div class="stat-card">
    <div class="stat-label">${c.label}</div>
    <div class="stat-value" style="color:${c.color||"inherit"}">${c.value}</div>
    ${c.sub?`<div class="stat-sub">${c.sub}</div>`:""}
  </div>`).join("");

  // â”€â”€ WEAK INTERVALS
  const sorted=[...readings].sort((a,b)=>new Date(a.date)-new Date(b.date));
  const weak=[];
  if (bom) {
    for (let i=0;i<sorted.length-1;i++) {
      const s=new Date(sorted[i].date), e=new Date(sorted[i+1].date);
      const dc=Math.round((e-s)/86400000); if (dc<=0) continue;
      let cov=0;
      for (let d=0;d<=dc;d++) {
        const day=new Date(s); day.setDate(s.getDate()+d);
        if (bom[day.toISOString().slice(0,10)]!==undefined) cov++;
      }
      const pct=Math.round(cov/(dc+1)*100);
      // Zobraz jen intervaly kde data ÄÃ¡steÄnÄ› existujÃ­ (>0% ale <100%)
      // Intervaly s 0% = historickÃ¡ data bez Netatmo, ignoruj
      if (pct>0 && pct<100) weak.push({from:sorted[i].date,to:sorted[i+1].date,dc,pct});
    }
  }
  document.getElementById("weakAlert").innerHTML=weak.length
    ?`<div class="alert alert-warn" style="margin-bottom:14px">
      <strong>âš  ${weak.length} interval${weak.length>1?"y":""} s neÃºplnÃ½mi Netatmo daty:</strong><br>
      ${weak.map(w=>`<span style="font-family:monospace;font-size:11px">${w.from} â†’ ${w.to} Â· ${w.pct}%</span>`).join("<br>")}
    </div>`:"";

  // Update chart mode button labels
  const bMonthly=document.getElementById("btnModeMonthly");
  const bDaily=document.getElementById("btnModeDaily");
  const bHourly=document.getElementById("btnModeHourly");
  if(bMonthly) bMonthly.textContent=t("chartMonthly");
  if(bDaily) bDaily.textContent=t("chartDaily");
  if(bHourly) bHourly.textContent=t("chartHourly");

  // â”€â”€ YEAR PILLS - skrÃ½t pro hourly mode
  const ay=availableYears();
  const yp=document.getElementById("yearPills");
  yp.style.display="";
  if (chartMode==="hourly") {
    // Zobraz VÅ ECHNY roky dostupnÃ© v netatmo datech, radio - jen jeden aktivnÃ­
    const allNetatmoYears=[...new Set(netatmoDays.map(x=>parseInt(x.date.slice(0,4))))].sort();
    // Pokud selHourlyYear nemÃ¡ data, nastav na poslednÃ­ dostupnÃ½
    if (!allNetatmoYears.includes(selHourlyYear)) selHourlyYear=allNetatmoYears[allNetatmoYears.length-1]||new Date().getFullYear();
    yp.innerHTML=`<span style="font-size:10px;color:${theme==="dark"?"#6e7681":"#6e7781"};font-family:monospace;margin-right:4px">${t("labelYears")}</span>`+
      allNetatmoYears.map(y=>{
        const c=palette[y]||"#94a3b8", active=y===selHourlyYear;
        return `<button class="year-pill" data-year="${y}" style="border-color:${c};background:${active?c:"transparent"};color:${active?"#fff":c}">${y}</button>`;
      }).join("");
  } else {
    yp.innerHTML=`<span style="font-size:10px;color:${theme==="dark"?"#6e7681":"#6e7781"};font-family:monospace;margin-right:4px">${t("labelYears")}</span>`+
      ay.map(y=>{
        const c=palette[y]||"#94a3b8", active=visYears.includes(y);
        return `<button class="year-pill" data-year="${y}" style="border-color:${c};background:${active?c:"transparent"};color:${active?"#fff":c}">${y}</button>`;
      }).join("");
  }

  // â”€â”€ MONTH PILLS
  const mp=document.getElementById("monthPills");
  if (chartMode==="daily"||chartMode==="hourly") {
    mp.style.display="flex";
    mp.innerHTML=`<span style="font-size:10px;color:${theme==="dark"?"#6e7681":"#6e7781"};font-family:monospace;margin-right:4px">${t("labelMonth")}</span>`+
      MO_SHORT().map((m,i)=>`<button class="month-pill${selMonth===i?" active":""}" data-month="${i}">${m}</button>`).join("");
  } else { mp.style.display="none"; }

  // â”€â”€ CHART
  const chartTitle=chartMode==="monthly"
    ?`${t("chartTitleMonthly")} Â· ${ul()}${useBoiler?" Â· "+t("chartBoilerOn"):" Â· "+t("chartLinear")}`
    :chartMode==="daily"
      ?`${t("chartTitleDailyPre")} Â· ${MO_LONG()[selMonth]} Â· ${ul()}`
      :`${t("chartTitleHourlyPre")} Â· ${MO_LONG()[selMonth]}`;
  document.getElementById("chartTitle").textContent=chartTitle;

  if (chartMode==="monthly") renderBarChart();
  else if (chartMode==="daily") renderAreaChart();
  else renderDailyNetatmoChart();

  // Legend
  if (chartMode==="hourly") {
    document.getElementById("chartLegend").innerHTML=
      `<div class="legend-item"><div style="width:12px;height:12px;background:${theme==="dark"?"#f97316":"#d95f00"};border-radius:2px"></div><span style="color:${theme==="dark"?"#8b949e":"#57606a"}">${lang==="cs"?"TopenÃ­ (h)":"Heating (h)"}</span></div>`+
      `<div class="legend-item"><div style="width:20px;height:2px;background:${theme==="dark"?"#38bdf8":"#0284c7"};border-radius:2px"></div><span style="color:${theme==="dark"?"#8b949e":"#57606a"}">${lang==="cs"?"Teplota (Â°C)":"Temp (Â°C)"}</span></div>`;
  } else {
    document.getElementById("chartLegend").innerHTML=visYears.map(y=>{
      const c=palette[y]||"#94a3b8";
      return chartMode==="monthly"
        ?`<div class="legend-item"><div style="width:12px;height:12px;background:${c};border-radius:2px"></div><span style="color:${c}">${y}</span></div>`
        :`<div class="legend-item"><div style="width:20px;height:2px;background:${c};border-radius:2px"></div><span style="color:${c}">${y}</span></div>`;
    }).join("");
  }

  // Info box
  document.getElementById("infoBox").innerHTML=useBoiler
    ?`<span>ğŸŸ¢</span><span><strong style="color:${successColor}">${t("infoWeighted")}</strong> ${t("infoWeightedDesc")}</span>`
    :`<span>ğŸ”¬</span><span><strong style="color:${theme==="dark"?"#58a6ff":"#1d4ed8"}">${t("infoLinear")}</strong> ${t("infoLinearDesc")}</span>`;

  // â”€â”€ READINGS LIST
  document.getElementById("readingsCount").textContent=t("readingsCount",{n:readings.length});
  const sortedR=[...readings].sort((a,b)=>new Date(b.date)-new Date(a.date));
  document.getElementById("readingsList").innerHTML=sortedR.map((r,i)=>{
    const next=sortedR[i+1];
    const diff=next?r.value-next.value:null;
    const days=next?Math.round((new Date(r.date)-new Date(next.date))/86400000):null;
    let iPct=null;
    if (bom&&diff!==null&&days!==null) {
      let cov=0;
      for (let d=0;d<=days;d++) {
        const day=new Date(next.date); day.setDate(new Date(next.date).getDate()+d);
        if (bom[day.toISOString().slice(0,10)]!==undefined) cov++;
      }
      iPct=Math.round(cov/(days+1)*100);
    }
    const pctColor=iPct===null?"":`color:${iPct===100?successColor:iPct>50?(theme==="dark"?"#f59e0b":"#a16207"):accentColor}`;
    const pctLabel=iPct===null?"":iPct===100?`<span class="reading-pct" style="${pctColor}">âœ“100%</span>`:`<span class="reading-pct" style="${pctColor}">âš ${iPct}%</span>`;
    const isLatest=i===0;
    const latestBg=""; // bez zvlÃ¡Å¡tnÃ­ho pozadÃ­ - oranÅ¾ovÃ¡ teÄka staÄÃ­

    // EDITING STATE
    if (editingId!==null && String(editingId)===String(r.id)) {
      return `<div class="reading-row editing" data-id="${r.id}">
        <div class="edit-row-top">
          <input class="edit-input edit-input-date" type="date" id="editDate_${r.id}" value="${r.date}">
          <input class="edit-input edit-input-val" type="number" id="editVal_${r.id}" value="${r.value}" placeholder="mÂ³">
          <input class="edit-input edit-input-note" type="text" id="editNote_${r.id}" value="${r.note||""}" placeholder="${t('placeholderNote')}">
          <button class="btn-save-edit" data-save="${r.id}">${t("btnSave")}</button>
          <button class="btn-cancel-edit" data-canceledit="${r.id}">${t("btnCancel")}</button>
        </div>
        <div class="edit-err" id="editErr_${r.id}"></div>
      </div>`;
    }

    // CONFIRM DELETE STATE
    if (pendingDelId!==null && String(pendingDelId)===String(r.id)) {
      return `<div class="reading-row confirm-del" data-id="${r.id}">
        <div class="reading-dot${isLatest?" latest":""}"></div>
        <span class="reading-date">${r.date}</span>
        <span class="confirm-del-msg">${t("confirmDelete")}</span>
        <button class="btn-cancel-del" data-canceldel="${r.id}">${t("btnBack")}</button>
        <button class="btn-confirm-del" data-confirmdel="${r.id}">${t("btnDelete")}</button>
      </div>`;
    }

    // NORMAL STATE
    return `<div class="reading-row${isLatest?" latest-row":""}" style="${latestBg}" data-id="${r.id}">
      <div class="reading-dot${isLatest?" latest":""}"></div>
      <span class="reading-date">${r.date}</span>
      <span class="reading-value">${r.value.toLocaleString("cs-CZ")} mÂ³</span>
      ${diff!==null?`<span class="reading-diff">+${diff.toFixed(1)}</span>`:""}
      ${days!==null&&diff!==null?`<span class="reading-days">${days}d</span>`:""}
      ${pctLabel}
      ${r.note?`<span style="font-size:11px;color:${theme==="dark"?"#6e7681":"#6e7781"};flex:1">${r.note}</span>`:"<span style='flex:1'></span>"}
      <button class="btn-edit" data-edit="${r.id}" title="Upravit">âœï¸</button>
      <button class="btn-del" data-del="${r.id}" title="Smazat">âœ•</button>
    </div>`;
  }).join("");

  // â”€â”€ UPDATE STATIC i18n LABELS
  const i18nEls=document.querySelectorAll("[data-i18n]");
  i18nEls.forEach(el=>{ const k=el.dataset.i18n; if(T[lang][k]) el.textContent=T[lang][k]; });
  // Upload zone
  const upTitle=document.getElementById("uploadTitle");
  const upDesc=document.getElementById("uploadDesc");
  const upBadges=document.getElementById("uploadBadges");
  const upBtn=document.getElementById("btnUploadLabel");
  if(upTitle) upTitle.textContent=t("uploadTitle");
  if(upDesc) upDesc.innerHTML=t("uploadDesc");
  if(upBadges) upBadges.innerHTML=t("uploadBadges").map(b=>`<span class="upload-badge">${b}</span>`).join("");
  if(upBtn) upBtn.textContent=t("btnUpload");
  // Add button
  const addBtn=document.getElementById("btnAdd");
  if(addBtn) addBtn.textContent=t("btnAdd");
  // Form placeholders
  const inVal=document.getElementById("inValue");
  if(inVal) inVal.placeholder=t("placeholderValue");
  const inNote=document.getElementById("inNote");
  if(inNote) inNote.placeholder=t("placeholderNote");

  // â”€â”€ NETATMO TAB
  renderNetatmoTab();
}

function renderNetatmoTab() {
  const successColor=theme==="dark"?"#34d399":"#0a8c5a";

  // Coverage
  const covWrap=document.getElementById("coverageWrap");
  const sorted=[...readings].sort((a,b)=>new Date(a.date)-new Date(b.date));
  if (!netatmoDays.length||sorted.length<2) { covWrap.innerHTML=""; }
  else {
    const bs=new Set(netatmoDays.map(d=>d.date));
    const first=new Date(sorted[0].date), last=new Date(sorted[sorted.length-1].date);
    const cov={}, cur=new Date(first.getFullYear(),first.getMonth(),1);
    while (cur<=last) {
      const y=cur.getFullYear(), m=cur.getMonth();
      const key=`${y}-${String(m+1).padStart(2,"0")}`;
      const dim=new Date(y,m+1,0).getDate(); let covered=0;
      for (let d=1;d<=dim;d++) if (bs.has(`${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`)) covered++;
      cov[key]={year:y,month:m,pct:Math.round(covered/dim*100)};
      cur.setMonth(cur.getMonth()+1);
    }
    const mutedColor=theme==="dark"?"#8b949e":"#57606a";
    const warnColor=theme==="dark"?"#f59e0b":"#a16207";
    const accentColor=theme==="dark"?"#f97316":"#d95f00";
    const borderColor=theme==="dark"?"#30363d":"#b1bac4";
    // Rozsah importovanÃ½ch dat - prvnÃ­ a poslednÃ­ den
    const allDates=[...bs].sort();
    const importFrom=allDates[0];
    const importTo=allDates[allDates.length-1];
    // DoporuÄenÃ­ pro pÅ™Ã­Å¡tÃ­ import - den po poslednÃ­m importovanÃ©m
    const nextImportDate=new Date(importTo);
    nextImportDate.setDate(nextImportDate.getDate()+1);
    const nextImportStr=nextImportDate.toISOString().slice(0,10);

    covWrap.innerHTML=`<div class="panel">
      <div class="panel-header">POKRYTÃ NETATMO DAT PER MÄšSÃC</div>
      <div class="panel-body">
        <div style="background:${theme==="dark"?"#0d1117":"#f6f8fa"};border:1px solid ${borderColor};border-radius:6px;padding:10px 14px;margin-bottom:14px;font-size:12px;font-family:monospace">
          <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:center">
            <div>
              <span style="color:${mutedColor}">${lang==="cs"?"ImportovÃ¡no:":"Imported:"}</span>
              <strong style="color:${theme==="dark"?"#e6edf3":"#1f2328"}"> ${importFrom} â†’ ${importTo}</strong>
              <span style="color:${mutedColor}"> (${allDates.length} ${lang==="cs"?"dnÃ­":"days"})</span>
            </div>
            <div>
              <span style="color:${mutedColor}">${lang==="cs"?"PÅ™Ã­Å¡tÃ­ import od:":"Next import from:"}</span>
              <strong style="color:${accentColor}"> ${nextImportStr}</strong>
            </div>
          </div>
        </div>
        <div style="display:flex;gap:12px;margin-bottom:12px;flex-wrap:wrap">
          ${[[successColor,"100%"],[warnColor,">50%"],[accentColor,"<50%"],[borderColor,"0%"]].map(([c,t])=>
            `<div style="display:flex;align-items:center;gap:5px"><div style="width:10px;height:10px;background:${c};border-radius:2px"></div><span style="font-size:11px;color:${mutedColor}">${t}</span></div>`
          ).join("")}
        </div>
        ${Object.entries(cov).sort().map(([key,c])=>{
          const pct=c.pct;
          const color=pct===100?successColor:pct>50?warnColor:pct>0?accentColor:borderColor;
          // Rozsah dnÃ­ v mÄ›sÃ­ci kterÃ½ byl importovÃ¡n
          const dim=new Date(c.year,c.month+1,0).getDate();
          const mKey=`${c.year}-${String(c.month+1).padStart(2,"0")}`;
          const mDays=[...allDates].filter(d=>d.startsWith(mKey)).sort();
          const mFrom=mDays[0]?mDays[0].slice(8):"â€“";
          const mTo=mDays[mDays.length-1]?mDays[mDays.length-1].slice(8):"â€“";
          const rangeLabel=mDays.length>0?` <span style="font-size:10px;color:${mutedColor}">${parseInt(mFrom)}.â€“${parseInt(mTo)}.</span>`:"";
          return `<div class="cov-row">
            <span class="cov-label">${MO_SHORT()[c.month]} ${c.year}${rangeLabel}</span>
            <div class="cov-track"><div class="cov-fill" style="width:${pct}%;background:${color}"></div></div>
            <span class="cov-pct" style="color:${color}">${pct}%</span>
          </div>`;
        }).join("")}
        <div style="margin-top:14px;display:flex;justify-content:flex-end">
          <button id="btnClearNetatmo" style="background:${theme==="dark"?"rgba(248,81,73,.1)":"rgba(185,28,28,.07)"};border:1px solid ${theme==="dark"?"rgba(248,81,73,.3)":"rgba(185,28,28,.25)"};border-radius:5px;color:${theme==="dark"?"#f85149":"#b91c1c"};padding:5px 12px;font-size:11px;font-family:monospace">Vymazat Netatmo data</button>
        </div>
      </div>
    </div>`;
  }

  // How-to
  const accentColor=theme==="dark"?"#f97316":"#d95f00";
  const mutedColor=theme==="dark"?"#8b949e":"#57606a";
  document.getElementById("howtoWrap").innerHTML=netatmoDays.length?"":
    `<div class="panel"><div class="panel-body">
      <p style="font-size:12px;color:${mutedColor};font-weight:600;margin-bottom:12px">Jak exportovat z Netatmo Energy:</p>
      ${t("howtoSteps").map((s,i)=>
        `<div style="display:flex;gap:10px;margin-bottom:8px;align-items:flex-start">
          <div style="width:20px;height:20px;border-radius:50%;background:${accentColor};color:#fff;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0">${i+1}</div>
          <p style="font-size:13px;color:${mutedColor};line-height:1.5">${s}</p>
        </div>`
      ).join("")}
    </div></div>`;
}

// â”€â”€ EVENT HANDLERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Tabs
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(`screen-${btn.dataset.tab}`).classList.add("active");
    // Redraw charts after tab becomes visible so offsetWidth is correct
    if (btn.dataset.tab==="charts") {
      requestAnimationFrame(()=>{
        if (chartMode==="monthly") renderBarChart(); else renderAreaChart();
      });
    }
  });
});

// Theme
document.getElementById("themeBtn").addEventListener("click",()=>{
  theme=theme==="dark"?"light":"dark";
  renderAll();
});

// Unit
document.querySelectorAll(".unit-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    unit=btn.dataset.unit;
    document.querySelectorAll(".unit-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    renderAll();
  });
});

// Chart mode
document.querySelectorAll(".chart-mode-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    chartMode=btn.dataset.mode;
    document.querySelectorAll(".chart-mode-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    if (chartMode==="hourly") {
      // Nastav selHourlyYear na aktuÃ¡lnÃ­ rok pokud existujÃ­ data, visYears nemÄ›nÃ­me
      const allNY=[...new Set(netatmoDays.map(x=>parseInt(x.date.slice(0,4))))];
      const curYear=new Date().getFullYear();
      if (!allNY.includes(selHourlyYear)) selHourlyYear=allNY.includes(curYear)?curYear:allNY[allNY.length-1]||curYear;
    }
    renderAll();
  });
});

// Year pills (delegated)
document.getElementById("yearPills").addEventListener("click",e=>{
  const y=parseInt(e.target.dataset.year);
  if (!y) return;
  if (chartMode==="hourly") {
    // Radio - jen jeden rok, nezÃ¡vislÃ½ od visYears
    selHourlyYear=y;
  } else {
    // Multi-select pro RoÄnÃ­ a MÄ›sÃ­ÄnÃ­
    if (visYears.includes(y)) visYears=visYears.filter(x=>x!==y);
    else visYears=[...visYears,y].sort();
    try { localStorage.setItem("plynograf_visYears", JSON.stringify(visYears)); } catch(e){}
  }
  renderAll();
});

// Month pills (delegated)
document.getElementById("monthPills").addEventListener("click",e=>{
  const m=parseInt(e.target.dataset.month);
  if (isNaN(m)) return;
  selMonth=m;
  renderAll();
});

// Add reading
document.getElementById("inDate").value=new Date().toISOString().slice(0,10);
function addReading() {
  const errEl=document.getElementById("addErr");
  errEl.style.display="none";
  const date=document.getElementById("inDate").value;
  const val=parseFloat(document.getElementById("inValue").value.replace(",","."));
  const note=document.getElementById("inNote").value;
  if (!date||isNaN(val)) { errEl.textContent=t("errFillAll"); errEl.style.display="block"; return; }
  const all=[...readings,{date,value:val}].sort((a,b)=>new Date(a.date)-new Date(b.date));
  for (let i=1;i<all.length;i++) {
    if (Number(all[i].value)<Number(all[i-1].value)) {
      errEl.textContent=t("errOrder")+` (${all[i-1].date}: ${Number(all[i-1].value).toLocaleString("cs-CZ")} â†’ ${all[i].date}: ${Number(all[i].value).toLocaleString("cs-CZ")})`; 
      errEl.style.display="block"; return;
    }
  }
  const newR = {id:nextId++,date,value:val,note};
  readings.push(newR);
  saveReading(newR);
  document.getElementById("inValue").value="";
  document.getElementById("inNote").value="";
  renderAll();
}
document.getElementById("btnAdd").addEventListener("click",addReading);
document.getElementById("inValue").addEventListener("keydown",e=>e.key==="Enter"&&addReading());

// Readings list â€” all actions delegated
document.getElementById("readingsList").addEventListener("click",e=>{
  const btn=e.target;

  // âœ• â€” enter confirm mode
  const delId=btn.dataset.del;
  if (delId) {
    pendingDelId=delId; editingId=null; renderAll(); return;
  }

  // ZpÄ›t â€” cancel confirm
  if (btn.dataset.canceldel) {
    pendingDelId=null; renderAll(); return;
  }

  // Smazat â€” confirmed delete
  const confirmDel=btn.dataset.confirmdel;
  if (confirmDel) {
    const delR = readings.find(r=>String(r.id)===confirmDel);
    readings=readings.filter(r=>String(r.id)!==confirmDel);
    if (delR) deleteReading(delR.id);
    pendingDelId=null; renderAll(); return;
  }

  // âœï¸ â€” enter edit mode
  const editId=btn.dataset.edit;
  if (editId) {
    editingId=editId; pendingDelId=null; renderAll();
    setTimeout(()=>{ const el=document.getElementById(`editVal_${editId}`); if(el){el.focus();el.select();} },50);
    return;
  }

  // ZruÅ¡it edit
  if (btn.dataset.canceledit) {
    editingId=null; renderAll(); return;
  }

  // âœ“ UloÅ¾it edit
  const saveId=btn.dataset.save;
  if (saveId) {
    const newDate=document.getElementById(`editDate_${saveId}`).value;
    const newVal=parseFloat(document.getElementById(`editVal_${saveId}`).value.replace(",","."));
    const newNote=document.getElementById(`editNote_${saveId}`).value.trim();
    const errEl=document.getElementById(`editErr_${saveId}`);

    if (!newDate||isNaN(newVal)) { errEl.textContent=t("editErrFill"); errEl.style.display="block"; return; }

    const origR = readings.find(r=>String(r.id)===saveId);
    const testList=[...readings.filter(r=>String(r.id)!==saveId),{id:saveId,date:newDate,value:newVal}]
      .sort((a,b)=>new Date(a.date)-new Date(b.date));
    for (let i=1;i<testList.length;i++) {
      if (testList[i].value<testList[i-1].value) {
        errEl.textContent=t("editErrOrder"); errEl.style.display="block"; return;
      }
    }

    readings=readings.map(r=>String(r.id)===saveId?{...r,date:newDate,value:newVal,note:newNote}:r);
    const updR=readings.find(r=>String(r.id)===saveId);
    if(updR) saveReading(updR);
    editingId=null; renderAll(); return;
  }
});

// Save edit on Enter key in edit inputs
document.getElementById("readingsList").addEventListener("keydown",e=>{
  if (e.key!=="Enter") return;
  const row=e.target.closest(".editing");
  if (!row) return;
  const saveId=row.dataset.id;
  if (saveId) document.querySelector(`[data-save="${saveId}"]`)?.click();
});

// Language toggle
document.querySelector(".lang-toggle").addEventListener("click",e=>{
  const l=e.target.dataset.lang;
  if (!l||l===lang) return;
  lang=l;
  document.querySelectorAll(".lang-btn").forEach(b=>{
    b.classList.toggle("active", b.dataset.lang===lang);
  });
  renderAll();
});

// File upload
document.getElementById("uploadZone").addEventListener("click",()=>document.getElementById("fileInput").click());
document.getElementById("fileInput").addEventListener("change",e=>{
  const file=e.target.files?.[0]; if (!file) return;
  const alertEl=document.getElementById("importAlert");
  const reader=new FileReader();
  reader.onload=ev=>{
    try {
      const res=parseNetatmoCSV(ev.target.result);
      const mergedPreview=mergeNetatmo(netatmoDays,res.days);
      const newDays=res.days.filter(d=>!netatmoDays.find(x=>x.date===d.date)).length;
      const updDays=res.days.filter(d=> netatmoDays.find(x=>x.date===d.date)).length;
      const accentC=theme==="dark"?"#f97316":"#d95f00";
      const mutedC=theme==="dark"?"#8b949e":"#57606a";
      // Zobraz preview s tlaÄÃ­tkem Potvrdit
      alertEl.innerHTML=`<div style="background:${theme==="dark"?"#161b22":"#f6f8fa"};border:1px solid ${theme==="dark"?"#30363d":"#d0d7de"};border-radius:8px;padding:14px 16px;margin-bottom:16px">
        <div style="font-size:13px;font-weight:700;margin-bottom:10px;color:${accentC}">
          ${lang==="cs"?"ğŸ“‹ NÃ¡hled importu":"ğŸ“‹ Import preview"}: ${file.name}
        </div>
        <div style="font-size:12px;color:${mutedC};display:flex;flex-wrap:wrap;gap:12px;margin-bottom:12px">
          <span>ğŸ“… ${res.dateFrom} â†’ ${res.dateTo}</span>
          <span>ğŸ“Š ${res.days.length} ${lang==="cs"?"dnÃ­ v souboru":"days in file"}</span>
          <span style="color:${theme==="dark"?"#34d399":"#0a8c5a"}">âœš ${newDays} ${lang==="cs"?"novÃ½ch":"new"}</span>
          ${updDays>0?`<span style="color:${accentC}">â†» ${updDays} ${lang==="cs"?"aktualizovanÃ½ch":"updated"}</span>`:""}
          <span>ğŸ—ƒ ${lang==="cs"?"Po importu celkem":"Total after import"}: <strong>${mergedPreview.length} ${lang==="cs"?"dnÃ­":"days"}</strong></span>
        </div>
        <div style="display:flex;gap:8px">
          <button id="btnConfirmImport" style="background:${accentC};color:#fff;border:none;border-radius:5px;padding:6px 16px;font-size:12px;font-family:monospace;font-weight:700;cursor:pointer">
            ${lang==="cs"?"âœ“ Potvrdit import":"âœ“ Confirm import"}
          </button>
          <button id="btnCancelImport" style="background:transparent;border:1px solid ${theme==="dark"?"#30363d":"#d0d7de"};border-radius:5px;padding:6px 14px;font-size:12px;font-family:monospace;color:${mutedC};cursor:pointer">
            ${lang==="cs"?"ZruÅ¡it":"Cancel"}
          </button>
        </div>
      </div>`;
      // Potvrdit
      document.getElementById("btnConfirmImport").onclick=()=>{
        netatmoDays=mergedPreview;
        saveNetatmoDays(res.days);
        alertEl.innerHTML=`<div class="alert alert-success" style="margin-bottom:16px">
          <strong>${t("importSuccess")}: ${file.name}</strong><br>
          ğŸ“… ${res.dateFrom} â†’ ${res.dateTo} &nbsp;Â·&nbsp; ğŸ“Š ${res.days.length} ${t("importDays")} &nbsp;Â·&nbsp; ğŸ—ƒ ${t("importTotal")}: <strong>${netatmoDays.length} ${t("importDays")}</strong>
        </div>`;
        renderAll();
      };
      // ZruÅ¡it
      document.getElementById("btnCancelImport").onclick=()=>{
        alertEl.innerHTML="";
      };
    } catch(err) {
      alertEl.innerHTML=`<div class="alert alert-error" style="margin-bottom:14px">âš  ${err.message}</div>`;
    }
  };
  reader.readAsText(file,"utf-8");
  e.target.value="";
});

// Clear Netatmo (delegated)
document.getElementById("coverageWrap").addEventListener("click",e=>{
  if (e.target.id==="btnClearNetatmo") {
    // NahraÄ tlaÄÃ­tko inline potvrzenÃ­m
    const btn=e.target;
    const mutedC=theme==="dark"?"#8b949e":"#57606a";
    btn.outerHTML=`
      <span style="display:flex;align-items:center;gap:8px;font-size:12px;color:${mutedC}">
        <span>${lang==="cs"?"Smazat "+netatmoDays.length+" dnÃ­?":"Delete "+netatmoDays.length+" days?"}</span>
        <button id="btnClearConfirm" style="background:rgba(248,81,73,.15);border:1px solid rgba(248,81,73,.4);border-radius:5px;color:#f85149;padding:4px 12px;font-size:11px;font-family:monospace;cursor:pointer">${lang==="cs"?"Ano, smazat":"Yes, delete"}</button>
        <button id="btnClearCancel" style="background:transparent;border:1px solid ${theme==="dark"?"#30363d":"#d0d7de"};border-radius:5px;color:${mutedC};padding:4px 10px;font-size:11px;font-family:monospace;cursor:pointer">${lang==="cs"?"ZruÅ¡it":"Cancel"}</button>
      </span>`;
    return;
  }
  if (e.target.id==="btnClearConfirm") {
    netatmoDays=[];
    clearNetatmoCloud();
    document.getElementById("importAlert").innerHTML="";
    renderAll();
    return;
  }
  if (e.target.id==="btnClearCancel") {
    renderAll(); // pÅ™ekresli pÅ¯vodnÃ­ tlaÄÃ­tko
    return;
  }
});

// Resize â†’ redraw charts
window.addEventListener("resize",()=>{ if(document.getElementById("screen-charts").classList.contains("active")) { if(chartMode==="monthly") renderBarChart(); else if(chartMode==="daily") renderAreaChart(); else renderDailyNetatmoChart(); } });

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// App is initialized by Supabase auth check above (sb.auth.getSession)
</script>
<div id="appFooter" style="text-align:center;padding:12px;font-size:10px;font-family:monospace;color:#30363d;user-select:none;">
  GasChart <span id="appVersion"></span>
</div>
</body>
</html>
